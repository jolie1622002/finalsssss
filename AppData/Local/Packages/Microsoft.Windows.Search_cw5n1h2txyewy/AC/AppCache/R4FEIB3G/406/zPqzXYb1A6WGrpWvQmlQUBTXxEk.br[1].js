var __extends=this&&this.__extends||function(){var n=function(t,i){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])},n(t,i)};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),__spreadArrays,WSB;(function(n){var r="NT",p="NF",t="https://substrate.office.com{0}/api/v1/",w=t+"events",o=t+"init",b=t+"suggestions?query=",k=t+"query",d=t+"recommendations",s="SubstrateSearchService",g="https://outlook.office365.com/autodiscover/autodiscover.json/v1.0/{0}?Protocol={1}",u="AutoDiscoveryKey",h="gwsflt.",nt="textdecorations",c="scenario",tt="setflight",it="debug",l="entitytypes",rt="1",ut="scopes",ft="people.directorysearch",et="Authorization",f="Content-Type",ot="X-AnchorMailbox",st="X-Client-Language",ht="X-Client-LocalTime",a="Client-Request-Id",v="User-Agent",ct="X-Debug-ExternalExp",lt="X-Client-Flights",e="application/json",at=15,vt=n.MinuteToMs,yt=2e3,i,y=!1,pt=function(t){function pt(r,f,e,s,c){var p,l=t.call(this,c||pt.getDataSource(f,e))||this,w,a,k,b,v;return l._accessTokenManager=r,l._authType=f,l._providerType=e,l._storage=s,l._autoDiscoveryData={stem:"/search",timestamp:-1},y||(y=!0,a=[],k=function(n){return n.split(",").filter(function(n){return n.toLocaleLowerCase().startsWith(h)}).map(function(n){return n.substr(h.length)})},n.TestHookUrlParameters&&a.push.apply(a,((p=n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters["3sflights"])!==null&&p!==void 0?p:"").split(",")),i=a.join(","),ThresholdUtilities.getCortanaHeaders(function(n){var t,r;n&&(t=n["X-BM-ClientFeatures"],t&&(r=k(t),r.length>0&&(a.push.apply(a,r),i=a.join(","))))})),(n.TestHookUrlParameters===null||n.TestHookUrlParameters===void 0?void 0:n.TestHookUrlParameters.clearAutoDCache)&&l._storage.removeItem(u),b=l._storage.getItem(u),b&&(v=n.safeExecute(function(){return JSON.parse(b)},"parseAutoDiscovery",null),v&&!v.errorState?l._autoDiscoveryData=v:l._storage.removeItem(u)),n.Host.bindAccessTokenAvailable(function(t){var r,f,i;if(t==l._authType){if(l._providerType==0){if(r=n.getCurrentTime(),w&&(f=r-w,f<vt))return;w=r;l.fetchUrl(o,null,"",function(){},null,function(){return!0})}i=n.getCurrentDate();i.setDate(i.getDate()-1);l._autoDiscoveryData.timestamp<i.getTime()&&l.getStem()(t,function(t){t.timestamp=n.getCurrentTime();l._autoDiscoveryData=t;t.errorState||l._storage.setItem(u,JSON.stringify(t))})}}),l}return __extends(pt,t),pt.prototype.getName=function(){return"SubstrateDataProvider "+this._dataSource},pt.prototype.createUrl=function(i){if(this._providerType==1||this._providerType==2)return this.getBaseUrl();if(this._providerType==0){if(i.scope==n.Scope.Documents){var r=n.getEffectiveQuery(i);if(r!=i.queryToFetch)return this.getBaseUrl()+n.encodeQueryParameter(r.toLocaleLowerCase())}return t.prototype.createUrl.call(this,i)}throw new Error("Not implemented");},pt.prototype.getBaseUrl=function(){if(this._providerType==0)return b;if(this._providerType==1)return k;if(this._providerType==2)return d;throw new Error("Not implemented");},pt.prototype.getClientFlights=function(){return this._providerType==2?"recEnableDuplicateMeetingAttachments":null},pt.getDataSource=function(n,t){if(t==0)return n==1?"SSUE":"SSUC";if(t==1)return n==1?"SSEE":"SSEC";if(t==2&&n==1)return"SREE";throw new Error("Not implemented");},pt.prototype.getPostBody=function(t){var r,u,f,i;if(this._providerType==1){r=void 0;u=n.getEffectiveScope(t);switch(u){case n.Scope.Emails:f=[{Score:{SortDirection:"Desc",Count:n.config.maxNumberOfEmailsInTopResult}},{Time:{SortDirection:"Desc"}}];r=this.buildPostBodyForQueryEndpoint(t,"Message",["Exchange"],f);break;case n.Scope.Documents:case n.Scope.All:i=void 0;switch(n.config.queryProvenances){case 0:i=["SharePoint"];break;case 1:i=["OneDriveBusiness"];break;case 2:i=["SharePoint","OneDriveBusiness"];break;default:throw new Error("Unexpected query provenances: "+n.config.queryProvenances);}r=this.buildPostBodyForQueryEndpoint(t,"Documents",i,[{Score:"Desc"}]);break;default:throw new Error("Unsupported scope "+t.scope);}return JSON.stringify(r)}return this._providerType==2?JSON.stringify(this.buildPostBodyForRecommendationsEndpoint(t)):""},pt.prototype.buildPostBodyForQueryEndpoint=function(n,t,i,r){return this.buildPostBody(t,"WindowsSearchBoxL2",undefined,n.queryToFetch,i,r,"ProvenanceOptimized","Forward")},pt.prototype.buildPostBodyForRecommendationsEndpoint=function(t){if(n.config.use3sRecRecommendedFiles&&t.isSearchHomeZI)return this.buildPostBody("Document","WSB.RecommendedFiles");var i=new Date(n.getCurrentTime()).toISOString(),r=new Date(n.getCurrentTime()+at*n.MinuteToMs).toISOString(),u=[{EntityType:"Event",StartDateTime:i,EndDateTime:r,Top:2},{EntityType:"Document",Top:10}];return this.buildPostBody("Document","WSB.MeetingRelatedEntities",u)},pt.prototype.buildPostBody=function(t,i,r,u,f,e,o,s){switch(i){case"WSB.RecommendedFiles":return{EntityRequests:[{}],Cvid:n.Host.getConversationId(),Scenario:{Name:i}};default:return{EntityRequests:[{Query:u?{QueryString:u}:undefined,QueryParameters:r,EntityType:t,Provenances:f,Sort:e,PropertySet:o}],Cvid:n.Host.getConversationId(),TextDecorations:s,Scenario:{Name:i}}}},pt.prototype.getStem=function(){var i=this;return n.Async.safeChainWithGlobalCaching("getStem",function(u){return ThresholdUtilities.createPromise(function(o){i._accessTokenManager.getAccount(u,n.getSubstrateResourceOrScope(u),!1,!0,function(u){var c,h,l;u&&u.UserName?(c=n.formatString(g,[u.UserName,s]),h={},h[f]=e,h[a]=n.Host.getConversationId(),h[v]=navigator.userAgent,l=function(t,i,r){var u,f,e;if(r){o({stem:"",errorState:r});return}if(u=i,!u){o({stem:""});return}if(!u.Url){o({stem:"",errorState:"NAU"});return}if(u.Protocol!=s){o({stem:"",errorState:"NAP"});return}if(f=n.tryParseUrl(u.Url,!0),e=f?f.path:null,!e){o({stem:"",errorState:"NAS"});return}o({stem:e})},t.prototype.fetchUrl.call(i,c,h,"",l,null,function(){return!0})):o({stem:"",errorState:r})})})},function(){return"autoDiscovery"})},pt.prototype.getAllAccountTokens=function(t,i){if(t||n.RuntimeConfig.QfMode!=5)this._accessTokenManager.getAccount(this._authType,n.getSubstrateResourceOrScope(this._authType),!1,!0,function(n){n&&n.Token?i([n]):i(null,r)});else{var u=SearchAppWrapper.CortanaApp.fileExplorerSuggestionPage.currentSyncRootAccount;u?this._accessTokenManager.getAccountByUserName(!0,1,u,!1,!0,function(n){n&&n.Token?i([n]):i(null,r)}):n.isFileExplorerCurrentPathThisPcOrQuickAccess?this._accessTokenManager.getAllSyncingAccounts(!0,1,!1,!0,function(n){n.length>0?i(n):i(null,r)}):(SharedLogHelper.LogError("fetchUrl",null,new Error("Substrate provider called without currentSyncRootAccount")),i(null,p))}},pt.prototype.fetchUrl=function(i,r,u,f,e,s){var c=this,a,h,l;if(!this._autoDiscoveryData.stem){f(this._dataSource,null,this._autoDiscoveryData.errorState,null,!0);return}a=i==o;i=n.formatString(i,[this._autoDiscoveryData.stem]);r||(r={});h={numOfPendingResponses:0};n.config.enableFetchStartLogging&&n.InstrumentationHelper.instrumentFetchProviderBegin(n.SequenceNumberManager.getSequenceNumber(),"SSDPU:"+this._dataSource);l=function(o){var l=Object.assign({},r);l[et]="Bearer "+o.Token;c._authType==1&&!n.SubstrateTenantName&&o.TenantName&&(n.SubstrateTenantName=o.TenantName);l[ot]=o.RoutingHint;t.prototype.fetchUrl.call(c,i,l,u,function(n,t,i,r,u){--h.numOfPendingResponses;f(n,t,i,r,u,h.numOfPendingResponses!=0)},e,s)};this.getAllAccountTokens(a,function(n,t){t?f(c._dataSource,null,t,null,null,!1):n?(h.numOfPendingResponses=n.length,n.forEach(function(n){return l(n)})):(h.numOfPendingResponses=1,l(null))})},pt.prototype.fetch=function(r,u,o,s,h,c){var b=this,d=n.isDataSourceEnabled(this._dataSource,r),y,k,w,p,g;(r.isSearchHomeZI&&this._dataSource==="SSUE"&&typeof n.isAuthLogEnabled=="function"&&n.isAuthLogEnabled()&&_w.bfbWsbTel&&bfbWsbTel.logPerf("[SubstrateDataProvider.Suggestion]: fetch SearchHome",{msbTenantStatus:typeof n.getTenantMsbStatus=="function"&&n.getTenantMsbStatus(),IsMsbInternalTenant:typeof n.getIsMsbInternalTenant=="function"&&n.getIsMsbInternalTenant(),shouldForceEnterpriseAccount:typeof n.shouldForceEnterpriseAccount=="function"&&n.shouldForceEnterpriseAccount(),dataSourceEnabled:d,isMsftAccountConnected:n.isMsftAccountConnected}),d)&&(n.config.enableFetchStartLogging&&n.InstrumentationHelper.instrumentFetchProviderBegin(o,"SSDP:"+this._dataSource),y={},y[st]=n.uiLanguageCache,y[ht]=n.getDateWithTimezone(),y[v]=navigator.userAgent,typeof _CachedFlights!="undefined"&&_CachedFlights.sort&&(y[ct]=_CachedFlights.sort().join(",")),y[a]=n.InstrumentationHelper.getImpressionGuid(o),y[f]=e,k=this.buildParams(c,r.scope,!r.queryToFetch),this._providerType!=0||k[l])&&(w=this.getClientFlights(),i&&(w=w?w+","+i:i),w&&(y[lt]=w),p=null,r.isSearchHomeZI&&(p=n.safeSetTimeout(function(){sb_ct(p);p=null;u(b._dataSource,null,"SubstrateTimeout")},yt,"SubstrateDataProvider Fetch")),g=function(t,i,f,e,o,s){var h=parseInt(f);if((h==403||h==401)&&n.safeSetTimeout(function(){return b._accessTokenManager.getAccount(b._authType,n.getSubstrateResourceOrScope(b._authType),!0,!0,function(){})},0,"SubstrateDataProvider onResponseReceived"),r.isSearchHomeZI){if(p==null)return;sb_ct(p);p=null}u(t,i,f,e,o,s)},t.prototype.fetch.call(this,r,g,o,s,h,k,y))},pt.prototype.buildParams=function(t,i,r){var f,u={},e;return this._providerType==0&&(u[n.Service.QueryParams.ConversationId]=t[n.Service.QueryParams.ConversationId],u[nt]=rt,this._authType!=1||r||i!=n.Scope.People?i!=n.Scope.All&&(u[c]=ut):u[c]=ft,u[l]=this.getEntityTypes(i,r)),n.TestHookUrlParameters&&(e=(f=n.TestHookUrlParameters["3sflights"])!==null&&f!==void 0?f:"",e&&(u[tt]=e),n.TestHookUrlParameters["3sdebug"]&&(u[it]="1")),u},pt.prototype.getEntityTypes=function(t,i){var r,u,f;switch(t){case n.Scope.Documents:r="Documents";break;case n.Scope.People:r="People";break;case n.Scope.All:u=[];this._authType==1&&u.push("Documents");i||n.RuntimeConfig.QfMode==5||(f=typeof n.isTenantMsbEnabled=="function"&&n.isTenantMsbEnabled(),f||u.push("People"));r=u.join(",");break;default:throw new Error("Unsupported scope "+t);}return r},pt.prototype.instrumentClick=function(t,i){if(t&&i){var u=[{Key:t,Value:[{Name:"entityclicked",Attributes:[{Key:"id",Value:i},{Key:"localtime",Value:n.getDateWithTimezone()}]}]}],r={};r[f]=e;this.fetchUrl(w,r,JSON.stringify(u),function(){},null,function(){return!0})}},pt}(n.CortanaJsonDataProvider);n.SubstrateDataProvider=pt})(WSB||(WSB={})),function(n){function l(t,i,r){var u=n.OfficeTypeExtensionConfigs[t];u?n.LocalDataProvider.getApps(u.appIds,function(t){var f=!n.Map.isEmpty(t);f?i(u.uri):r()}):r()}function a(t,i,r){var u=t?new URL(t):null;!u||u.pathname&&u.pathname.indexOf(":")!=-1?n.Host.launchUri(i):l(r,function(i){return n.Host.launchUri(i+t)},function(){return n.Host.launchUri(i)})}function v(t,i,r){n.setExtraVerbs(t,function(){var u=[];return u.push({verb:n.JumplistActionItemType[n.JumplistActionItemType.S_OpenInBrowser],displayName:n.Host.getLocString("OpenInBrowser"),executeSync:function(){return n.Host.launchUri(i)},icon:{type:1,content:"&#xE774"}}),t.locationUrl&&u.push({verb:n.JumplistActionItemType[n.JumplistActionItemType.S_OpenFileLocationInBrowser],displayName:n.Host.getLocString("OpenFileLocationIn",r),executeSync:function(){return n.Host.launchUri(t.locationUrl)},icon:{type:2,content:"&#xE838"}}),t.url&&SearchAppWrapper.CortanaApp.copyToClipboard&&u.push({verb:n.JumplistActionItemType[n.JumplistActionItemType.S_CopyFullPath],displayName:n.Host.getLocString("CopyFullPath"),executeSync:function(){return SearchAppWrapper.CortanaApp.copyToClipboard(t.url,"")},icon:{type:1,content:"&#xE8C8"}}),u},!1)}function h(t,i,r,u,e,o,s,h,c,l,y,p,w,b,k,d,g,nt,tt,it,rt){var ct=n.ScopeConfig[n.Scope.Documents].icon,et,ut,ot,lt,ft,at,vt,st,ht;return u||(u=r+"?web=1"),o=HitHighlightingParser.removeMarkers(o),s&&(s=s.toLocaleLowerCase()),et="FL",ut=n.createSuggestion(i,e,s&&n.getIconForTypeAsync(ct,"."+s),ct,et,o,n.InstrumentedItem.createInstrumentedItem(d,et),8,d,!0),ut.instrumentPingBack=k,ut.click=function(){return a(r,u,s)},ut.extensionLC="."+s,ut.lastModifiedDate=n.toDate(c),ut.lastModifiedBy=l,ut.lastAccessDate=n.toDate(y),ut.author=p,ut.matchedOnlyOnAuthor=w,ut.matchedOnlyOnContent=b,ut.textContentIfMatched=tt,ut.siteTitle=rt,ut.url=r,ot=h=="OneDriveBusiness"?3:h=="SharePoint"?4:undefined,lt=n.nicerCloudFilesEnabled(i,ut),n.setDocumentLocationProperties(ut,o,h,lt),w?ut.match=n.createMatch(n.MatchType.Author,p):e.includes(HitHighlightingParser.startMarker)||(ut.match=n.tryGetLocationMatch(ut.path,g)||it),i.isSearchHomeZI||(ut.sourceForGroup=ot),ft=new Date(n.getCurrentDate().toUTCString()),t?(ut.meeting=t,ut.features.push("MeetingRecommendation"),at=new Date(t.Start),vt=Math.floor((at.getTime()-ft.getTime())/n.MinuteToMs),ut.explanation=vt>0?n.Host.getLocString("DocumentRelatedToMeeting",HitHighlightingParser.addMarkers(t.Subject.trim()),f(ft,new Date(t.Start))):n.Host.getLocString("DocumentRelatedToMeetingNow",HitHighlightingParser.addMarkers(t.Subject.trim()))):i.isSearchHomeZI&&(st=ut.lastModifiedBy&&ut.lastModifiedDate&&(!ut.lastAccessDate||ut.lastModifiedDate>=ut.lastAccessDate)?f(ut.lastModifiedDate,ft):null,st?ut.explanation=n.Host.getLocString("DocumentLastModifiedBy",HitHighlightingParser.addMarkers(ut.lastModifiedBy),st):ut.lastAccessDate&&(ht=f(ut.lastAccessDate,ft),ht&&(ut.explanation=n.Host.getLocString("DocumentLastAccessed",HitHighlightingParser.addMarkers(n.Host.getLocString("YouLabel")),ht)))),n.setFileTemplate(i,g,nt,ut),v(ut,u,n.getGroupSourceDisplayName(ot)),ut.reactKey=et+e+p+r,ut}function f(t,i){var r,u,f,e;return!t||!i?null:(r=i.getTime()-t.getTime(),r<0)?null:(u=r/n.DayToMs,u>=1)?n.Host.getLocString("TimeDayShorthandPattern",Math.floor(u).toString()):(f=r/n.HourToMs,f>=1)?n.Host.getLocString("TimeHourShorthandPattern",Math.floor(f).toString()):(e=r/n.MinuteToMs,n.Host.getLocString("TimeMinuteShorthandPattern",Math.floor(e).toString()))}var r={Word:{appIds:["Microsoft.Office.WINWORD.EXE.15","Microsoft.Office.WINWORD.EXE.16","{6D809377-6AF0-444B-8957-A3773F02200E}\\Microsoft Office\\Office15\\WINWORD.EXE","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}\\Microsoft Office\\Office15\\WINWORD.EXE","{6D809377-6AF0-444B-8957-A3773F02200E}\\Microsoft Office\\Office16\\WINWORD.EXE","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}\\Microsoft Office\\Office16\\WINWORD.EXE","Microsoft.Office.Word_8wekyb3d8bbwe!microsoft.word"],uri:"ms-word:ofe|u|"},Excel:{appIds:["Microsoft.Office.EXCEL.EXE.15","Microsoft.Office.EXCEL.EXE.16","{6D809377-6AF0-444B-8957-A3773F02200E}\\Microsoft Office\\Office15\\EXCEL.EXE","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}\\Microsoft Office\\Office15\\EXCEL.EXE","{6D809377-6AF0-444B-8957-A3773F02200E}\\Microsoft Office\\Office16\\EXCEL.EXE","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}\\Microsoft Office\\Office16\\EXCEL.EXE","Microsoft.Office.Excel_8wekyb3d8bbwe!microsoft.excel"],uri:"ms-excel:ofe|u|"},PowerPoint:{appIds:["Microsoft.Office.POWERPNT.EXE.15","Microsoft.Office.POWERPNT.EXE.16","{6D809377-6AF0-444B-8957-A3773F02200E}\\Microsoft Office\\Office15\\POWERPNT.EXE","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}\\Microsoft Office\\Office15\\POWERPNT.EXE","{6D809377-6AF0-444B-8957-A3773F02200E}\\Microsoft Office\\Office16\\POWERPNT.EXE","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}\\Microsoft Office\\Office16\\POWERPNT.EXE","Microsoft.Office.PowerPoint_8wekyb3d8bbwe!microsoft.pptim"],uri:"ms-powerpoint:ofe|u|"},Visio:{appIds:["{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}\\Microsoft Office\\Office15\\VISIO.EXE","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}\\Microsoft Office\\Office14\\VISIO.EXE","{6D809377-6AF0-444B-8957-A3773F02200E}\\Microsoft Office\\Office16\\VISIO.EXE","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}\\Microsoft Office\\Office16\\VISIO.EXE","Microsoft.Office.VISIO.EXE.15"],uri:"ms-visio:ofe|u|"},OneNote:{appIds:["Microsoft.Office.ONENOTE.EXE.15","Microsoft.Office.ONENOTE.EXE.16","{6D809377-6AF0-444B-8957-A3773F02200E}\\Microsoft Office\\Office15\\ONENOTE.EXE","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}\\Microsoft Office\\Office15\\ONENOTE.EXE","{6D809377-6AF0-444B-8957-A3773F02200E}\\Microsoft Office\\Office16\\ONENOTE.EXE","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}\\Microsoft Office\\Office16\\ONENOTE.EXE","Microsoft.Office.OneNote_8wekyb3d8bbwe!microsoft.onenoteim"],uri:"onenote:"}},e="sip:",c=["Microsoft.Office.lync.exe.15","{6D809377-6AF0-444B-8957-A3773F02200E}Microsoft OfficeOffice15lync.exe","{6D809377-6AF0-444B-8957-A3773F02200E}Microsoft OfficeOffice16lync.exe","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}Microsoft OfficeOffice15lync.exe","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}Microsoft OfficeOffice16lync.exe","{6D809377-6AF0-444B-8957-A3773F02200E}MSOfficeOffice15lync.exe","{6D809377-6AF0-444B-8957-A3773F02200E}MSOfficeOffice16lync.exe","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}MSOfficeOffice15lync.exe","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}MSOfficeOffice16lync.exe","Microsoft.Office.Desktop_8wekyb3d8bbwe!Lync","com.squirrel.Teams.Teams",],t=r.Word,i=r.Excel,u=r.PowerPoint,o=r.Visio,s;n.OfficeTypeExtensionConfigs={doc:t,dot:t,dotx:t,docx:t,docm:t,docb:t,xls:i,xlm:i,xlsx:i,xlsm:i,xlsb:i,xltx:i,ppt:u,pps:u,pptx:u,pptm:u,vsd:o,vsdx:o,one:r.OneNote};s=function(){function t(n,t,i,r){this._substrateSuggestionsDataProvider=n;this._accessTokenManager=t;this._substrateProfilePictureProvider=i;this._authType=r;this._mailboxLocations={}}return t.prototype.parse=function(t,i,r,u,f,e){var s=this,o;if(n.isDataSourceEnabled(r,t)){if(o=[],!u||!u.Groups){e(r,o,null);return}var l=r=="SSUE"?n.config.aadPeopleCardHandoffEnabled&&!(typeof n.isTenantMsbEnabled=="function"&&n.isTenantMsbEnabled()):n.config.msaPeopleCardHandoffEnabled,p=n.getEffectiveQuery(t),a=n.isL2(t),v=n.config.msbQws3sSugHideTimestamp&&t.isSearchHomeZI,y=function(c){for(var y,it,rt,b,nt,ut,ft,et,d,tt,k,w=0,g=u.Groups;w<g.length;w++)if(y=g[w],y.Suggestions&&y.Suggestions.length)switch(y.Type){case"Documents":for(it=y.Suggestions,rt=function(r){var f=n.safeExecute(function(){return h(undefined,t,r.AccessUrl||r.Url,null,r.Text,r.FileName,r.FileExtension,r.FileSourceType=="OneDriveForBusiness"?"OneDriveBusiness":"SharePoint",v?null:r.DateModified?r.DateModified+"Z":null,r.ModifiedByDisplayName,v?null:r.DateAccessed?r.DateAccessed+"Z":null,r.CreatedBy||HitHighlightingParser.removeMarkers(r.Author),r.PropertyHits&&r.PropertyHits[0]=="Author",!1,function(){return s._substrateSuggestionsDataProvider.instrumentClick(u.Instrumentation.TraceId,r.ReferenceId)},i,p,a,"",null,r.SourceTitle)},"buildSubstrateDocumentSuggestion");if(f&&n.isValidSuggestion(f,"SubstrateDocumentsSuggestionsParser")&&(o.push(f),t.isSearchHomeZI&&typeof n.enableQws=="function"&&n.enableQws()&&typeof n.shouldForceEnterpriseAccount=="function"&&n.shouldForceEnterpriseAccount()&&o.length>=n.config.ziRecommendedDocsResultsCount))return"break"},b=0,nt=it;b<nt.length;b++)if(k=nt[b],ut=rt(k),ut==="break")break;t.isSearchHomeZI||n.decorateSuggestionsWithParentFolder(o);break;case"People":for(ft=y.Suggestions,et=function(f){var e=n.safeExecute(function(){return s.buildPersonSuggestion(l,f,i,u.Instrumentation.TraceId,a,r,t,c)},"buildPersonSuggestion");e&&n.isValidSuggestion(e,"SubstratePeopleSuggestionsParser")&&o.push(e)},d=0,tt=ft;d<tt.length;d++)k=tt[d],et(k);l&&n.safeExecute(function(){return s.prefetchPeopleCards(o.filter(function(n){return n.type=="PPL"}),i,f)},"prefetchPeopleCards");n.isL2(t)||s.decorateContactsWithSameDisplayName(o,t);break;default:SharedLogHelper.LogError("parseSubstrateResponse",y.Type,new Error("Unexpected group type"))}e(r,o,null)};r=="SSUE"?n.LocalDataProvider.getApps(c,function(t){return y(!n.Map.isEmpty(t))}):y(!1)}},t.prototype.prefetchPeopleCards=function(t,i,r){t.length&&this.getPeopleCardTokenAndMailboxLocation(function(u){var o,f,e,s;u&&u.token&&u.location&&i==n.SequenceNumberManager.getSequenceNumber()&&r()&&(o=u.location+"api/v1/personacards/preparePersona",f=SearchAppWrapper.CortanaApp.createStringMap(),f.Authorization="Bearer "+u.token,f["X-ClientCorrelationId"]=n.InstrumentationHelper.getImpressionGuid(i),f["X-ClientType"]="6",e=SearchAppWrapper.CortanaApp.createStringMap(),e["Content-Type"]="application/json",s=JSON.stringify(t.map(function(n){return{Smtp:n.email,PersonaType:"User"}})),n.Async.safeChain("prefetchPeopleCards",function(){return SearchAppWrapper.CortanaApp.makeHttpRequestAsync(1,o,f,s,e)},function(n){if(n.statusCode!=200&&n.statusCode!=204){var t=new Error("Prefetch request failed with status code: "+n.statusCode);SharedLogHelper.LogError("prefetchPeopleCards",null,t)}}))})},t.prototype.buildPersonSuggestion=function(t,i,r,u,f,o,s,h){var w=this,g,l,nt,p,ft;if(!i.EmailAddresses||!i.EmailAddresses[0])return null;var et=i.PeopleType=="Group",tt=i.EmailAddresses[0],a=HitHighlightingParser.removeMarkers(tt),y,it;et?y={content:"&#xE716",type:2}:(y=this._substrateProfilePictureProvider.getPersonDefaultIcon(i.DisplayName),it=this._substrateProfilePictureProvider.getProfilePictureIcon(this._authType,a,y));var rt=o=="SSUE",b="PPL",c=n.createSuggestion(s,i.Text,it,y,b,i.DisplayName,n.InstrumentedItem.createInstrumentedItem(r,b),rt?8:12,r,!0),k=i.Id,d;rt&&(g=i.Id.split("@"),k=g[0],d=g[1]);c.email=a;c.emailHH=tt;c.uniqueName=a;l=i.ImAddress;l&&!l.startsWith(e)&&(l=l.includes(":")?undefined:e+l);l&&(c.imAddress=l,nt=l.substr(e.length),nt!=a&&(c.alternativeEmail=nt));p=k&&d&&!t;c.tooltip=this.getPersonTooltip(i.DisplayName,i.Department,i.JobTitle,i.OfficeLocation,i.CompanyName,a,c.alternativeEmail);c.instrumentPingBack=function(){return w._substrateSuggestionsDataProvider.instrumentClick(u,i.ReferenceId)};c.click=function(n){return w.onPersonSuggestionClick(t,p,a,c.query,r,n,k,d)};var ut=n.Host.getLocString("Email"),ot=function(){return n.Host.launchUri("mailto:"+a)},v={};return v[ut]=[{text:a,click:ot}],c.alternativeEmail&&(ft=function(){return n.Host.launchUri("mailto:"+c.alternativeEmail)},v[ut].push({text:c.alternativeEmail,click:ft})),i.OfficeLocation&&(v[n.Host.getLocString("Location")]=[{text:i.OfficeLocation}]),i.CompanyName&&(v[n.Host.getLocString("Company")]=[{text:i.CompanyName}]),c.previewMetadata=v,c.department=i.Department,this.setPersonTemplate(c,f,i.JobTitle,s),this.setPersonContextMenuItems(c,t||p,h),!n.RuntimeConfig.AlwaysWide&&(t||p)&&(c.calculateChildSuggestions=function(){return w.getPersonChildSuggestions(s,c,r,o,h)}),c.reactKey=b+i.PeopleType+i.DisplayName+i.Id,c},t.prototype.getPersonChildSuggestions=function(t,i,r,u,f){var e=[];e.push(this.getChildSuggestion(t,i,"CortanaAnnotation_Email","&#xE715","mailto:"+i.email,"PPLE",r));i.imAddress&&f&&e.push(this.getChildSuggestion(t,i,"SendInstantMessage","&#xE8BD",i.imAddress,"PPLM",r));i.childSuggestions=e;i.calculateChildSuggestions=null;n.InstrumentationHelper.instrumentDataSource(r,u,i.childSuggestions,null)},t.prototype.getChildSuggestion=function(t,i,r,u,f,e,o){var h=n.Host.getLocString(r),s=n.createSuggestion(t,h,null,{type:2,content:u},e,h,n.InstrumentedItem.createInstrumentedItem(o,e),i.handoffType,o,!1,null,null,!0);return s.parent=i,s.groupType=n.GroupType.Contact,s.click=function(){return n.Host.launchUri(f)},s.instrumentPingBack=i.instrumentPingBack,s.reactKey=e+h+f,s},t.prototype.getPeopleCardTokenAndMailboxLocation=function(t){var i=this;this._accessTokenManager.getAccount(this._authType,this._authType==1?"394866fc-eedb-4f01-8536-3ff84b16be2a":"LiveProfileCard.Access",!1,!0,function(r){var u,e,o,f,s;if(!r||!r.Token){t(null);return}if(u=r.Token,e=i._mailboxLocations[r.RoutingHint],e){t({token:u,location:e});return}o=SearchAppWrapper.CortanaApp.createStringMap();f=SearchAppWrapper.CortanaApp.createStringMap();f.Authorization="Bearer "+u;f["X-ClientType"]="6";s="https://loki.delve.office.com/api/v1/configuration/cortana";n.Async.safeChain("lokiConfiguration",function(){return SearchAppWrapper.CortanaApp.makeHttpRequestAsync(0,s,f,"",o)},function(f){if(f.statusCode!==200){t(null);return}n.Async.safeChain("lokiConfigurationResponse",function(){return f.readAsStringAsync()},function(f){if(!f){t(null);return}var e=n.safeExecute(function(){return JSON.parse(f)},"parseLokiConfiguration");if(!e||!e.LokiUrl){t(null);return}i._mailboxLocations[r.RoutingHint]=e.LokiUrl;t({token:u,location:e.LokiUrl})},function(){return t(null)})},function(){return t(null)})})},t.prototype.getSharePointHost=function(n){for(var f,i,e,t,s,l,a,v=new DOMParser,u=0,h=n.value;u<h.length;u++)if(f=h[u],f.serviceElements)for(i=0,e=f.serviceElements;i<e.length;i++){var y=e[i],p=v.parseFromString(y,"text/xml"),r=p.getElementsByTagName("ServiceParameter"),o=void 0,c=!1;for(t=0;t<r.length;t++)if(s=r[t].getElementsByTagName("Name"),s[0].childNodes[0].nodeValue=="IsDefaultDataLocation"?(l=r[t].getElementsByTagName("Value"),l[0].childNodes[0].nodeValue=="True"&&(c=!0)):s[0].childNodes[0].nodeValue=="SPO_MySiteHost_AboutMeUrl"&&(a=r[t].getElementsByTagName("Value"),o=a[0].childNodes[0].nodeValue),c&&o)return o}return null},t.prototype.onPersonSuggestionClick=function(t,i,r,u,f,e,o,s){var c=this,h=function(){return n.Host.launchUri("mailto:"+r)},l=function(){var t=function(){return n.Host.launchUri(c._sharePointSiteHostUrl+"?aadObjectId="+o)};c._sharePointSiteHostUrl?t():c._accessTokenManager.getAccount(1,"https://graph.windows.net/",!1,!0,function(i){if(!i||!i.Token){h();return}var u=SearchAppWrapper.CortanaApp.createStringMap(),r=SearchAppWrapper.CortanaApp.createStringMap();r.Authorization="Bearer "+i.Token;n.Async.safeChain("getSharePointUrl",function(){return SearchAppWrapper.CortanaApp.makeHttpRequestAsync(0,"https://graph.windows.net/"+s+"/tenantDetails/"+s+"/serviceInfo?api-version=1.6-internal",r,"",u)},function(i){if(i.statusCode!==200){h();return}n.Async.safeChain("readSharePointUrlResponse",function(){return i.readAsStringAsync()},function(i){var r=i?n.safeExecute(function(){return JSON.parse(i)},"parseSharePointUrlResponse"):null;if(!r){h();return}c._sharePointSiteHostUrl=c.getSharePointHost(r);c._sharePointSiteHostUrl?t():h()},h)},h)})};t?this.getPeopleCardTokenAndMailboxLocation(function(t){if(f==n.SequenceNumberManager.getSequenceNumber())if(t&&t.token&&t.location){var o=t.location+"api/v1/personacard?clientType=Cortana&userSmtp="+r+"&ClientCorrelationId="+n.InstrumentationHelper.getImpressionGuid(f)+"&cts="+e+"&CultureInfoName="+n.uiLanguageCache;n.Host.launchWebContent(o,u,t.token)}else i?l():h()}):i?l():h()},t.prototype.setPersonContextMenuItems=function(t,i,r){n.setExtraVerbs(t,function(){var u=[],f=t.childSuggestions&&t.childSuggestions.some(function(n){return n.displayed});return f||(u.push({verb:n.JumplistActionItemType[n.JumplistActionItemType.S_SendEmail],displayName:n.Host.getLocString("CortanaAnnotation_Email"),executeSync:function(){return n.Host.launchUri("mailto:"+t.email)},isDefault:!i,icon:{content:"&#xE715",type:2}}),t.imAddress&&r&&u.push({verb:n.JumplistActionItemType[n.JumplistActionItemType.S_SendInstantMessage],displayName:n.Host.getLocString("SendInstantMessage"),executeSync:function(){return n.Host.launchUri(t.imAddress)},icon:{content:"&#xE8BD",type:2}})),SearchAppWrapper.CortanaApp.copyToClipboard&&u.push({verb:n.JumplistActionItemType[n.JumplistActionItemType.S_CopyPersonDetails],displayName:n.Host.getLocString("CopyDetails"),executeSync:function(){return SearchAppWrapper.CortanaApp.copyToClipboard(t.tooltip.replace(/\n/g,"\r\n"),"")},icon:{type:1,content:"&#xE8C8"}}),u},!0)},t.prototype.setPersonTemplate=function(t,i,r,u){var e=n.getEffectiveQuery(u),f;r?(t.jobTitle=r,t.primaryMetadata=r):t.text!=t.emailHH&&(t.primaryMetadata=t.emailHH);e&&(t.text.includes(HitHighlightingParser.startMarker)||(t.emailHH.includes(HitHighlightingParser.startMarker)?(t.template=1,t.primaryMetadata=t.emailHH):t.alternativeEmail&&(f=HitHighlightingParser.addMarkers(t.alternativeEmail,e),f.includes(HitHighlightingParser.startMarker)&&(t.template=1,t.primaryMetadata=f))));t.narratorText=n.getNarratorText(t);i?(t.template=u.isSearchHomeZI?0:1,u.isSearchHomeZI||t.classNames.push("people","topResultTemplateInGroups")):t.template==1&&t.classNames.push("forceNoWrapOutsideTopResult")},t.prototype.getPersonTooltip=function(n,t,i,r,u,f,e){var h="",c=[n,i,t,r,u],o,l,s;for(n!=f&&c.push(f),e&&n!=e&&c.push(e),o=0,l=c;o<l.length;o++)s=l[o],s&&(h+=h?"\n"+s:s);return h},t.prototype.decorateContactsWithSameDisplayName=function(t,i){for(var r,e,u,f=0;f<t.length-1;++f)if(r=t[f],r.type=="PPL")for(e=f+1;e<t.length;++e)if(u=t[e],u.type=="PPL"&&r.text.toLocaleLowerCase()==u.text.toLocaleLowerCase()){n.isL2(i)||(r.template!=1&&r.classNames.push("forceNoWrapOutsideTopResult"),u.template!=1&&u.classNames.push("forceNoWrapOutsideTopResult"));r.template=u.template=1;r.primaryMetadata=r.emailHH;u.primaryMetadata=u.emailHH;break}},t}();n.SubstrateSuggestionsParser=s;n.buildSubstrateDocumentSuggestion=h;n.formatDurationShorthand=f}(WSB||(WSB={})),function(n){function r(n,t){return function(){return n(t)}}function u(n){return encodeURIComponent(n.replace(/-/g,"/").replace(/_/g,"+"))}var f=["Microsoft.Office.OUTLOOK.EXE.15","Microsoft.Office.OUTLOOK.EXE.16","{6D809377-6AF0-444B-8957-A3773F02200E}Microsoft OfficeOffice15OUTLOOK.EXE","{7C5A40EF-A0FB-4BFC-874A-C0F2E0B9FA8E}Microsoft OfficeOffice15OUTLOOK.EXE"],t="OutlookLaunchPref",i=[0,1],e="https://outlook.office365.com/mail/deeplink/attachment/{0}/{1}",o=function(){function o(n,t){this._substrateSuggestionsDataProvider=n;this._lightweightStorage=t;this._outlookLaunchPreference={}}return o.prototype.parse=function(t,i,r,u,f,e){var v=this,o,s,c,l,b,h,a,k;if(n.isDataSourceEnabled(r,t)){if(o=[],!u||!u.EntitySets){e(r,o,null);return}var y=n.getEffectiveQuery(t),p=n.getEffectiveScope(t),w=!1;for(s=0,c=u.EntitySets;s<c.length;s++)if(l=c[s],l.ResultSets)for(b=function(f){var k,c,s,h,a,d,e,b,l,g;if(f.Results)switch(p){case n.Scope.Emails:for(k=function(f){var e=n.safeExecute(function(){return v.buildMessageSuggestion(t,f.Source,i,r,u.Instrumentation?u.Instrumentation.TraceId:null,f.ReferenceId,y)},"buildMessageSuggestion");e&&n.isValidSuggestion(e,"parseSubstrateSearchResponse_emails",!1)&&o.push(e)},c=0,s=f.Results;c<s.length;c++)l=s[c],k(l);break;case n.Scope.Documents:case n.Scope.All:for(h=f.Results,a=r=="SREE"?(e=(s=f.RecommendationsContext)===null||s===void 0?void 0:s.MeetingContext)===null||e===void 0?void 0:e.Source:null,a&&(h=h.filter(function(n,t){if(n.Provenance!="Exchange")return!0;var i=n.Source.FileName;return!h.some(function(n,r){var u,f;return t==r?!1:n.Provenance=="Exchange"?!1:(f=n.Source,((u=f.LastShared)===null||u===void 0?void 0:u.SharingType)=="Attachment"&&f.FileName==i)})})),d=function(r){if(t.isSearchHomeZI&&n.config.use3sRecRecommendedFiles&&r.Provenance=="Exchange")return"continue";var e=n.safeExecute(function(){return v.buildDocumentSuggestion(a,r.Source,i,u.Instrumentation?u.Instrumentation.TraceId:null,r.ReferenceId,r.Provenance||f.Provenance,y,t)},"buildDocumentSuggestion");if(e&&n.isValidSuggestion(e,"parseSubstrateSearchResponse_documents")&&(o.push(e),t.isSearchHomeZI&&n.config.use3sRecRecommendedFiles&&typeof n.enableQws=="function"&&n.enableQws()&&typeof n.shouldForceEnterpriseAccount=="function"&&n.shouldForceEnterpriseAccount()&&o.length>=n.config.ziRecommendedDocsResultsCount))return"break"},e=0,b=h;e<b.length;e++)if(l=b[e],g=d(l),g==="break")break;w=!a;break;default:SharedLogHelper.LogError("parseSubstrateSearchResponse",p.toString(),new Error("Unexpected scope"))}},h=0,a=l.ResultSets;h<a.length;h++)k=a[h],b(k);w&&n.decorateSuggestionsWithParentFolder(o);e(r,o,null)}},o.prototype.buildDocumentSuggestion=function(t,i,r,f,o,s,h,c){var it=this,p,w,d=h?HitHighlightingParser.addMarkers(i.FileName,h):i.FileName,l=d.includes(HitHighlightingParser.startMarker),v,y;if(h&&!l&&(!n.config.minLengthForContentMatch||c.queryToFetch.length<n.config.minLengthForContentMatch))return null;var g=i.Author==null?null:i.Author.DisplayName,b=n.matchesOnPropertyHH(g,h),rt=i.Description?n.decodeHtml(i.Description).replace(/<\/?[^>]+(>|$)/g,""):"",nt=n.tryGetTextContentMatch(rt,h),ut=nt[0],tt=nt[1],k=i.LastModifiedBy==null?null:i.LastModifiedBy.DisplayName,a;return l||b||(n.matchesOnPropertyHH(k,h)&&(a=n.createMatch(n.MatchType.LastModifiedBy,k)),a=a||tt),v=i.Url,y=i.WebUrl,s=="Exchange"&&(y=v,v=null,((p=i.LastShared)===null||p===void 0?void 0:p.AttachmentId)&&(t===null||t===void 0?void 0:t.Id)&&(y=n.formatString(e,[u(t.Id),u(i.LastShared.AttachmentId)]))),n.buildSubstrateDocumentSuggestion(t,c,v,y,d,i.FileName,i.FileExtension,s,i.LastModifiedDateTime,k,(w=i.UserRelationship)===null||w===void 0?void 0:w.LastAccessDateTime,g,!l&&b,!l&&!b&&!!tt,function(){return it._substrateSuggestionsDataProvider.instrumentClick(f,o)},r,h,n.isL2(c),ut,a,i.SiteTitle)},o.prototype.buildMessageSuggestion=function(t,i,r,u,f,e,o){var w=this,a,v,c,p;if(i.IsDraft)return null;if(!i.WebLink)return SharedLogHelper.LogError("buildMessageSuggestion",null,new Error("Missing web link")),null;if(a=i.From&&i.From.EmailAddress?i.From.EmailAddress.Name||i.From.EmailAddress.Address:null,v=i.Sender&&i.Sender.EmailAddress?i.Sender.EmailAddress.Name||i.Sender.EmailAddress.Address:null,!a&&!v)return SharedLogHelper.LogError("buildMessageSuggestion",null,new Error("No valid from or sender fields present")),null;var l=a||v,h=i.Subject,b=u=="SSEE",y="OLE",s=n.createSuggestion(t,HitHighlightingParser.addMarkers(l,o),null,null,y,h||l,n.InstrumentedItem.createInstrumentedItem(r,y),b?8:12,r,!0),k=b?1:2;return this.setEmailContextMenuItems(s,i.ItemHexId,i.WebLink,k),s.click=function(){return w.launchEmail(i.ItemHexId,i.WebLink,k)},s.template=1,s.classNames.push("email","forceNoWrapOutsideTopResult","topResultTemplateInGroups"),s.primaryMetadata=HitHighlightingParser.addMarkers(h,o),s.secondaryMetadata=HitHighlightingParser.addMarkers(i.Preview,o),s.tooltip=l+(h?"\n"+h:""),s.hc=i.SortOrderSource=="Relevance",s.previewIcon={content:"&#xE715",type:2,needsAccentColor:!0},i.HasAttachments&&(s.secondaryIcon={content:"&#xE723",type:2}),i.IsRead||s.classNames.push("accentColor"),i.DateTimeReceived&&(c=n.toDate(i.DateTimeReceived),p=n.getTodayTimeString(c),s.dateShort=p?p:c.toLocaleDateString(),s.dateLong=c.toLocaleString(navigator.language,{year:"numeric",month:"numeric",day:"numeric"}),s.dateAndTime=c.toLocaleString(navigator.language,{weekday:"long",month:"long",day:"numeric",year:"numeric",hour:"numeric",minute:"numeric"})),s.internetMessageId=i.InternetMessageId,s.instrumentPingBack=function(){return w._substrateSuggestionsDataProvider.instrumentClick(f,e)},s.narratorText=n.getNarratorText(s),s.subject=HitHighlightingParser.addMarkers(h,o),s.from=l,s.to=i.DisplayTo,s.preview=i.Preview,s.hasAttachment=i.HasAttachments,s.importance=i.Importance!="Normal"?n.Host.getLocString("EmailImportance",i.Importance):"",s.reactKey=y+i.WebLink,s},o.prototype.setEmailContextMenuItems=function(t,i,r,u){var e=this;i&&n.setExtraVerbsAsync(t,function(){var t=[];return ThresholdUtilities.createPromise(function(o){n.LocalDataProvider.getApps(f,function(f){var a=!n.Map.isEmpty(f);if(a){var h=e.getOutlookLaunchPreference(u),c="Outlook",l,s=Object.keys(f);s.length==1&&(c=f[s[0]].deviceItem.displayName,l=f[s[0]].getIcon);t.push({verb:"OpenInOutlookWeb",displayName:n.Host.getLocString("OpenIn","Outlook Web"),executeSync:function(){return e.launchOutlookWeb(r,u)},isDefault:h==0,icon:{content:"&#xE774",type:1}});t.push({verb:"LaunchOutlookNative",displayName:n.Host.getLocString("OpenIn",c),executeSync:function(){return e.launchOutlokNative(i,u)},isDefault:h==1,getIcon:l})}o(t)})})},!0)},o.prototype.launchOutlookWeb=function(t,i,r){var u=this;n.Host.launchUri(t,!1,function(){return u.setOutlookLaunchPreference(0,i)},r)},o.prototype.launchOutlokNative=function(t,i,r){var u=this;n.Host.launchOutlook(t,function(){return u.setOutlookLaunchPreference(1,i)},r)},o.prototype.launchEmail=function(t,u,f){for(var c,e,s,l=this,v=this.getOutlookLaunchPreference(f),o=[v],h=0,a=i;h<a.length;h++)c=a[h],n.contains(o,c)||o.push(c);for(s=o.length-1;s>=0;s--)switch(o[s]){case 1:e=r(function(n){return l.launchOutlokNative(t,f,n)},e);break;case 0:e=r(function(n){return l.launchOutlookWeb(u,f,n)},e)}e()},o.prototype.getOutlookLaunchPreference=function(n){if(!this._outlookLaunchPreference[n]){var r=parseInt(this._lightweightStorage.getItem(t+n));this._outlookLaunchPreference[n]=isNaN(r)?i[0]:r}return this._outlookLaunchPreference[n]},o.prototype.setOutlookLaunchPreference=function(n,i){this._outlookLaunchPreference[i]=n;this._lightweightStorage.setItem(t+i,n.toString())},o}();n.SubstrateSearchParser=o}(WSB||(WSB={})),function(n){function w(){var t=n.getCurrentTime()-p,i=!!u&&u>t;return f()||n.config.msbUseCachedMsbState&&v()&&i}function a(){return c()&&n.config.msbEnableFile}function b(){return f()&&a()&&n.config.msb3sFileOff}function r(){return c()?n.config.msbEnableQuickWorkSearchMS:n.config.msbEnableQuickWorkSearch}function k(){return r()&&n.config.msbHideTopApp}function d(){return r()&&n.config.msbQwsShowTopList}function g(){return r()&&n.config.msbEnableQwsCache}function nt(){return r()&&n.config.msbQwsShowRecommendedDocs}function tt(){return r()&&n.config.msbEnableBrandBar}function f(){return i===t.Enabled}function it(){return i===t.Disabled}function v(){return i===t.Unknown}function rt(){i=t.Disabled;s(!1)}function ut(){i=t.Enabled}function ft(){i=t.Unknown;s(!1)}function et(){return i}function s(n){o=n}function ot(){return f()&&o}function st(n){u=n}function ht(){return u}function ct(){if(typeof BingAtWork=="undefined")return"BingAtWorkNotReady";var n=BingAtWork.msbDataContext;if(n){if(n.dataLoadFired)return"DataLoaded";if(n.readyFired)return"Ready"}return"NotReady"}function lt(t){h=n.config.msbInternalTenants&&t!=null&&n.contains(n.config.msbInternalTenants,t)}function c(){return h}function at(n,t){return Math.random()*t+n}function vt(t){var i;try{if(i=n.getStoredMsbIcon(t),i==="")return"";var r=atob(i),u=r.startsWith("<svg")||r.startsWith("<?xml"),f=u?"svg+xml":"jpeg";return"data:image/"+f+";base64,"+i}catch(o){return""}}function yt(t){try{var i=vt(t),r="#"+n.getStoredMsbNavColor(t),u="#"+n.getStoredMsbFontColor(t),f=n.getStoredMsbTenantName(t);return{logoDataUri:i,backColor:r,companyName:f,fontColor:u}}catch(e){return undefined}}function pt(){return n.config.msbIsMicrosoftInternal&&n.config.msbEnableAuthLog}function wt(n,t){n.setItem(l,t?"1":"0")}function bt(n){return n.getItem(l)==="1"}function kt(n,t){t?n.setItem(e,t):n.removeItem(e)}function dt(n){return n.getItem(e)}function gt(n){var t=y(n);return(t===null||t===void 0?void 0:t.tenant_region_sub_scope)==="GCC"}function ni(t){return n.config.msbVerticalWorkScopeEnabled&&t==n.Scope.Work}function y(n){if(!n)return undefined;try{var t=n.split(".")[1],i=t.replace(/-/g,"+").replace(/_/g,"/"),r=decodeURIComponent(atob(i).split("").map(function(n){return"%"+("00"+n.charCodeAt(0).toString(16)).slice(-2)}).join(""));return JSON.parse(r)}catch(u){return undefined}}function ti(t){var i=BingAtWork.wsb.isGCC===!0?n.config.msbGccApiBaseUrl:n.config.msbApiBaseUrl;return i+"/"+t}function ii(n){var t,i=(t=n===null||n===void 0?void 0:n.headers)===null||t===void 0?void 0:t["x-msedge-ref"];return i&&i.substring(7,i.indexOf(" Ref B:"))}function ri(n){var i=n===null||n===void 0?void 0:n.trim(),t,r,u;return i?(t=i.indexOf(" "),t<=0)?null:(r=n.substring(0,t),u=n.substring(t+1),{firstName:r,lastName:u}):null}var t,o,h,l,e,ui;(function(n){n[n.Unknown=0]="Unknown";n[n.Enabled=1]="Enabled";n[n.Disabled=2]="Disabled"})(t=n.TenantMsbStatus||(n.TenantMsbStatus={}));var i=t.Unknown,u=undefined,p=432e6;n.shouldForceEnterpriseAccount=w;n.isMsbFileEnabled=a;n.is3sFileDisabled=b;n.enableQws=r;n.shouldHideTopApp=k;n.qwsShowTopList=d;n.enableQwsCache=g;n.enableQwsRecDocs=nt;n.enableBrandingBar=tt;n.isTenantMsbEnabled=f;n.isTenantMsbDisabled=it;n.isTenantMsbStatusUnknown=v;n.setTenantMsbDisabledStatus=rt;n.setTenantMsbEnabledStatus=ut;n.setTenantMsbUnknownStatus=ft;n.getTenantMsbStatus=et;o=!1;n.setIsMsbEduTenantEnabled=s;n.getIsMsbEduTenantEnabled=ot;n.setLastMsbEnabledTime=st;n.getLastMsbEnabledTime=ht;n.getMsbClientQfState=ct;h=!1;n.checkAndSetIsMsbInternalTenant=lt;n.getIsMsbInternalTenant=c;n.getRandomNumInRange=at;n.getMsbBranding=yt;n.isAuthLogEnabled=pt;l="MsbQfReady";n.setIsMsbClientQfTokenReady=wt;n.getIsMsbClientQfTokenReady=bt;e="QwsCache";n.setQuickWorkSearchCache=kt;n.getQuickWorkSearchCache=dt;n.isGCCTenant=gt;n.isMsbWorkScope=ni;n.parseJwt=y;n.getMsbUrl=ti;n.getTraceIdFromHeader=ii;n.getFirstAndLastName=ri,function(n){n[n.MsbAjaxMakeHttpRequestAsyncError=-1]="MsbAjaxMakeHttpRequestAsyncError";n[n.ResponseJsonParseError=-2]="ResponseJsonParseError";n[n.ReadResponseError=-3]="ReadResponseError";n[n.ReadErrorStatusResponseError=-4]="ReadErrorStatusResponseError";n[n.NoWsbAccessToken=-5]="NoWsbAccessToken";n[n.FetchError=-6]="FetchError";n[n.UncaughtError=-7]="UncaughtError"}(ui=n.ClientErrorCode||(n.ClientErrorCode={}))}(WSB||(WSB={})),function(n){function f(t){var i;if(!t)return{error:"BingAtWork.wsb.wsbAccessToken - not set"};if(i=n.parseJwt(t),!i)return{error:"BingAtWork.wsb.wsbAccessToken - failed to parse token"};var r=i.appid,u=i.aud,f=i.iss,e=i.scp,o=i.amr;return{appid:r,aud:u,iss:f,scp:e,amr:o}}function p(n,t){var i=JSON.stringify(t);n.setItem(u,i)}function e(n){n.removeItem(u)}function t(n){var t=n.getItem(u);if(t)try{return JSON.parse(t)}catch(i){e(n)}return null}function o(n){var i,r;if((r=(i=t(n))===null||i===void 0?void 0:i.tenantSettings)!==null&&r!==void 0)return r.tenantDisplayName}function s(n){var i,r;if((r=(i=t(n))===null||i===void 0?void 0:i.tenantSettings)!==null&&r!==void 0)return r.iconLarge}function h(n){var i,r;if((r=(i=t(n))===null||i===void 0?void 0:i.tenantSettings)!==null&&r!==void 0)return r.navColor}function c(n){var i,r;if((r=(i=t(n))===null||i===void 0?void 0:i.tenantSettings)!==null&&r!==void 0)return r.fontColor}function l(n){var i,r;return((r=(i=t(n))===null||i===void 0?void 0:i.tenantSettings)===null||r===void 0?void 0:r.isEdu)||!1}var i=1440,r=360,u="MsbTenantSetting",a="000000",v="ffffff",y=function(){function u(i){this._localStorage=i;this._fetchingTenant=!1;this._tenantEnabledHandlers=[];this._tenantDisabledHandlers=[];n.config.msbCleanTenantSettingLocalStorage&&this.cleanLocalTenantSettingState();var r=t(this._localStorage);n.setLastMsbEnabledTime(r===null||r===void 0?void 0:r.lastMsbEnabledTimestamp)}return u.prototype.bindTenantEnabled=function(n){this._tenantEnabledHandlers.push(n)},u.prototype.bindTenantDisabled=function(n){this._tenantDisabledHandlers.push(n)},u.prototype.checkTenantSettings=function(t,i,r,u){var f=this,e=n.getCurrentTime();this.shouldGetTenantSettings(e,u===null||u===void 0?void 0:u.RoutingHint)?this.checkTenantSettingsFromServer(t,function(n){f.checkTenantSettingsFromCache(t,function(){(n===null||n===void 0?void 0:n.hasNativeIssue)||_w.bfbWsbTel&&bfbWsbTel.logHttpError("Wsb Fetch Tenant Settings Auth Fails and No Cached Results Available");i(n)},r,u)},r,u):this.checkTenantSettingsFromCache(t,function(){_w.bfbWsbTel&&bfbWsbTel.logHttpError("Wsb Fetch Tenant Settings No Cached Results Available");i({})},r,u)},u.prototype.checkTenantSettingsFromCache=function(n,t,i,r){var u=this.getLocalTenantSetting();u?(this.updateTenantFlags(u,r),n()):(this.cleanLocalTenantSettingState(),t({}))},u.prototype.checkTenantSettingsFromServer=function(i,r,u,e){var y=this,p,w;this._fetchingTenant||(this._fetchingTenant=!0,p=BingAtWork.wsb.isGCC===!0?n.config.msbGccTenantApiUrl:n.config.msbTenantApiUrl,w={url:p,onSuccess:function(t,f){var o,s,h,c,b;if(t&&t.tenantSettings){var l={isEnabled:t.tenantSettings.isEnabled,isEdu:((o=t.tenantSettings.variants)===null||o===void 0?void 0:o.indexOf("Edu"))>=0,tenantDisplayName:t.tenantSettings.tenantDisplayName,iconLarge:t.tenantSettings.iconLarge,navColor:((s=t.tenantSettings.themeColors)===null||s===void 0?void 0:s[1])||a,fontColor:((h=t.tenantSettings.themeColors)===null||h===void 0?void 0:h[2])||v},p=n.getCurrentTime(),w=t.tenantSettings.isEnabled?p:undefined;y.updateTenantFlags(l,e);n.setLastMsbEnabledTime(w);y.updateTenantSettingStateCache(e===null||e===void 0?void 0:e.RoutingHint,200,p,w,l);y._fetchingTenant=!1;i()}else c="Response: "+JSON.stringify(t),b=n.getIsMsbInternalTenant()?c:"",_w.bfbWsbTel&&bfbWsbTel.logHttpError("Wsb Fetch Empty Tenant Settings","",{serverTraceId:f,statusCode:200,additionalMessage:b},{caller:u}),y._fetchingTenant=!1,r({})},onError:function(a,v){var g="[MSB.Error] checkTenantSettings: onError: "+JSON.stringify({statusCode:a,ajaxErrorInfo:v}),p;var w=a===404,b=a===401||a===403,nt=a===-1,k=n.getCurrentTime();w?(y.handleMsbDisable(),n.setLastMsbEnabledTime(undefined),y.updateTenantSettingStateCache(e===null||e===void 0?void 0:e.RoutingHint,404,k,undefined,{isEnabled:!1,tenantDisplayName:o(y._localStorage),iconLarge:s(y._localStorage),navColor:h(y._localStorage),fontColor:c(y._localStorage),isEdu:l(y._localStorage)})):(p=t(y._localStorage),y.updateTenantSettingStateCache(e===null||e===void 0?void 0:e.RoutingHint,a,k,p===null||p===void 0?void 0:p.lastMsbEnabledTimestamp,p===null||p===void 0?void 0:p.tenantSettings));var tt=w?"Wsb Fetch Tenant Settings Non MSB":"Wsb Fetch Tenant Settings Failed",d=n.getIsMsbInternalTenant()?"ResponseText: "+(v===null||v===void 0?void 0:v.responseText)+", ErrorMessages: "+(v===null||v===void 0?void 0:v.errorMessage):"",it=b?d+", token="+JSON.stringify(f(BingAtWork.wsb.wsbAccessToken)):d,rt=n.getIsMsbInternalTenant()?v===null||v===void 0?void 0:v.stackTrace:"";_w.bfbWsbTel&&bfbWsbTel.logHttpError(tt,v===null||v===void 0?void 0:v.message,{stackTrace:rt,serverTraceId:v===null||v===void 0?void 0:v.serverTraceId,statusCode:a,additionalMessage:it},{caller:u});y._fetchingTenant=!1;w?i():r({hasTokenIssue:b,hasNativeIssue:nt})}},n.Msb.sendAjax(w))},u.prototype.updateTenantSettingStateCache=function(n,i,r,u,f){var s=t(this._localStorage),h=s&&s.failedTimes,e,c,o;e=h+1;(i===200||i===404||i==-1)&&(e=0);c=this.getNextIntervalWaitTime(i,e);o={lastMsbEnabledTimestamp:u,lastTimestamp:r,nextRequestIntervalInMinutes:c,failedTimes:e,routingHint:n,tenantSettings:f};p(this._localStorage,o)},u.prototype.shouldGetTenantSettings=function(n,i){var r=t(this._localStorage),u=!0;if(r){var f=r.lastTimestamp,e=r.nextRequestIntervalInMinutes,o=r.routingHint;i===o&&(u=n>f+e*6e4)}return u},u.prototype.cleanLocalTenantSettingState=function(){e(this._localStorage)},u.prototype.handleMsbDisable=function(){n.setTenantMsbDisabledStatus();this._tenantDisabledHandlers&&this._tenantDisabledHandlers.forEach(function(t){n.safeExecute(function(){return t()},"MsbTenantManager::fireTenantDisabled")})},u.prototype.getLocalTenantSetting=function(){var n=t(this._localStorage);if(n!==null&&n!==void 0)return n.tenantSettings},u.prototype.updateTenantFlags=function(t,i){var r=t.isEnabled,u=t.isEdu;r?(n.isAuthLogEnabled()&&_w.bfbWsbTel&&bfbWsbTel.logPerf("[MsbTenantManager]: setTenantMsbEnabledStatus",{isMsbTenantEnabled:n.getTenantMsbStatus(),shouldForceEnterpriseAccount:n.shouldForceEnterpriseAccount(),clientQfState:n.getMsbClientQfState()}),n.setTenantMsbEnabledStatus(),n.setIsMsbEduTenantEnabled(u),this._tenantEnabledHandlers&&this._tenantEnabledHandlers.forEach(function(t){n.safeExecute(function(){return t(i===null||i===void 0?void 0:i.RoutingHint)},"MsbTenantManager::fireTenantEnabled")})):this.handleMsbDisable()},u.prototype.getNextIntervalWaitTime=function(t,u){var f=0,e;return t===200||t===404?f=n.getRandomNumInRange(i,r):u<=n.config.msbTenantSettingRetryNoWaitFailedTimes||t==-1?f=0:(e=(u-n.config.msbTenantSettingRetryNoWaitFailedTimes)*n.config.msbTenantSettingRetryInMin,f=t==503||t==429?f+e*3:f+e*4,f>=i+r&&(f=n.getRandomNumInRange(i,r))),f},u}();n.MsbTenantManager=y;n.getReducedTokenInfo=f;n.getLocalTenantSettingState=t;n.getStoredMsbTenantName=o;n.getStoredMsbIcon=s;n.getStoredMsbNavColor=h;n.getStoredMsbFontColor=c;n.getStoredMsbIsEdu=l}(WSB||(WSB={})),function(n){var t="AadUserId",i="MsbEnabledUserId",r="WsbVerifyAccountRequired",u=3e5,f=function(){function f(t,i,r){var u=this;this._accessTokenManager=t;this._localStorage=i;this._msbTenantManager=r;this._msbAccount=null;this._substrateAccount=null;this._userId=null;this._tenantId=null;this._tokenChanged=!1;this._tokenChangedHandlers=[];this._wsbAadReadyNotified=!1;this._accountTypeChangedIsFiring=!1;this._mockToken=null;t.bindAccountTypesChanged(function(){u.handleAcountTypeChanged()});t.bindVerifyAccountRequired(function(n,t){u.handleWsbVerifyAccountRequired(n,t)});t.bindAccessTokenAvailable(function(n,t){u.handleWsbAccessTokenAvailable(n,t)});r.bindTenantEnabled(function(n){u.handleTanentEnabled(n)});n.config.msbIsMicrosoftInternal&&_w.bfbWsbTel&&bfbWsbTel.logValue("BfbMsInternalFlag",n.config.msbIsMicrosoftInternal,{CodeLocation:"MsbTokenManager.constructor"})}return f.prototype.bindTokenChanged=function(n){this._tokenChangedHandlers.push(n);var t=this.getMsbToken();t&&n(t)},f.prototype.refreshMsbTokenAndCall=function(t,i){var u=this,r=this.getMsbToken();r?n.safeExecute(function(){return t(r)},"MsbTokenManager::refreshMsbTokenAndCall:callback - cached token"):this.callGetMsbAccount(!0,function(){var r=u.getMsbToken();r?n.safeExecute(function(){return t(r)},"MsbTokenManager::refreshMsbTokenAndCall:callback - fetched token"):i&&n.safeExecute(i,"MsbTokenManager::refreshMsbTokenAndCall:noTokenCallback")},"refreshMsbTokenAndCall")},f.prototype.refresh3sTokenAndCall=function(t,i){var r=this,u=this.get3sToken();u?n.safeExecute(function(){return t(u)},"MsbTokenManager::refresh3sTokenAndCall:callback - cached token"):n.config.msbFetch3sToken?this.callFetch3sAccount(function(){r.after3sAccountRefreshed(t,i)}):this.refreshMsbTokenAndCall(function(){r.callGet3sAccount(function(){r.after3sAccountRefreshed(t,i)})},function(){i&&n.safeExecute(function(){return i()},"MsbTokenManager::refresh3sTokenAndCall:noTokenCallback")})},f.prototype.after3sAccountRefreshed=function(t,i){var r=this.get3sToken();r?n.safeExecute(function(){return t(r)},"MsbTokenManager::refresh3sTokenAndCall:callback - fetched token"):i&&n.safeExecute(i,"MsbTokenManager::refresh3sTokenAndCall:noTokenCallback")},f.prototype.getMsbToken=function(){if(!this._msbAccount)return undefined;var t=n.getCurrentTime();return t>this._msbAccount.ExpireDateTime?(this._msbAccount=null,BingAtWork.wsb&&(BingAtWork.wsb.wsbAccessToken=null),undefined):this._msbAccount.Token},f.prototype.get3sToken=function(){if(!this._substrateAccount)return undefined;var t=n.getCurrentTime();return t>this._substrateAccount.ExpireDateTime?(this._substrateAccount=null,BingAtWork.wsb&&(BingAtWork.wsb.wsb3sAccessToken=null),undefined):this._substrateAccount.Token},f.prototype.getTokenExpiry=function(t,i){var r=n.parseJwt(this._msbAccount.Token);return(r===null||r===void 0?void 0:r.exp)?(r===null||r===void 0?void 0:r.exp)*1e3-3e5:i},f.prototype.notifyWsbAadReady=function(){!this._wsbAadReadyNotified&&n.isTenantMsbEnabled()&&(this._wsbAadReadyNotified=!0,_w.postMessage({messageType:"BingAtWork:WsbAadReady",userId:this._userId,tenantId:this._tenantId},"*"))},f.prototype.callGetMsbAccount=function(t,i,r){var u=this;if(!this._accessTokenManager.isAadAvailable()&&!n.config.msbMockToken){n.setTenantMsbDisabledStatus();this.clearUserTenantContext();this._msbTenantManager.cleanLocalTenantSettingState();i&&i(!1);return}this._accessTokenManager.getAccount(1,"9ea1ad79-fdb6-4f9a-8bc3-2b70f96e34c7",t,!0,function(t){n.config.msbMockToken&&(t=u.getMsbMockAccount());n.safeExecute(function(){return u.handleMsbAccount(t,i,r)},"Calling handleMsbAccount")})},f.prototype.callGet3sAccount=function(t){var i=this;this._accessTokenManager.getAccount(1,"https://substrate.office.com",!0,!0,function(r){n.safeExecute(function(){i.handleSubstrateAccount(r);t()},"Calling handleSubstrateAccount")})},f.prototype.callFetch3sAccount=function(t){var i=this;this.fetchMsb3sAccount(function(r){n.safeExecute(function(){i.handleSubstrateAccount(r);t()},"Calling handleSubstrateAccount")},function(){n.safeExecute(function(){i.handleSubstrateAccount(null);t()},"Calling handleMsbAccount with null 3s account")})},f.prototype.handleMsbAccount=function(i,r,u){var e=this,s=i&&i.Token,f,o;f=this.getAadUserInfo(i);this.updateTelemetryContext(f);f&&f.UserAadId&&this.trySendValueEvents(t,i===null||i===void 0?void 0:i.RoutingHint,{name:"LogAadUserId",value:""});s?(this.setMsbAccount(i),o=this._tokenChanged,this._msbTenantManager.checkTenantSettings(function(){e.handleMsbTokenChanged();r&&r(o)},function(n){(n===null||n===void 0?void 0:n.hasTokenIssue)&&(e._msbAccount=null,BingAtWork.wsb&&(BingAtWork.wsb.wsbAccessToken=null));e.handleMsbTokenChanged();r&&r(o)},u,this._msbAccount)):(n.setTenantMsbDisabledStatus(),r&&r(!1))},f.prototype.handleSubstrateAccount=function(n){var t=n&&n.Token;t&&this.setSubstrateAccount(n)},f.prototype.fetchMsb3sAccount=function(t,i){var r=this,u=this.getMsbToken();u||(_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Fetch 3S Token No Msb Token"),i());var f=BingAtWork.wsb.isGCC===!0?n.config.msbGcc3sTokenUrl:n.config.msb3sTokenUrl,e=f.replace("{cvid}",BingAtWork.context.conversationId),o={url:e,onSuccess:function(u){var e=r.make3sAccount(u),f,o;e?t(e):(f="[MSB.Error] fetching 3S token returns no token. response="+JSON.stringify(u),o=n.getIsMsbInternalTenant()?f:"",_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Fetch 3S Token Returns Invalid Response","",{additionalMessage:o}),i())},onError:function(t,r){var e=r.responseText,o=r.message,s=r.stackTrace,h=r.serverTraceId,u="[MSB.Error] fetching 3S token has error, details="+JSON.stringify({statusCode:t,responseText:e,message:o,stackTrace:s,serverTraceId:h}),f;f=n.getIsMsbInternalTenant()?u:"";_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Fetch 3S Token Failed","",{additionalMessage:f});i()}};n.Msb.sendAjax(o)},f.prototype.make3sAccount=function(t){if(!t||!t.token||!t.tokenExpiry||!t.tenant||!t.tenant.id||!t.user||!t.user.id||!t.user.displayName)return undefined;var r=t.token,f=t.tokenExpiry,e=t.tenant.id,i=t.user,o=i.id,s=i.displayName;return{Token:r,ExpireDateTime:f-u,UserName:s,RoutingHint:"OID:"+e+":"+o,LastUpdated:n.getCurrentDate().getTime()}},f.prototype.setMsbAccount=function(t){var f=this._msbAccount&&this._msbAccount.Token,r=t.Token,i,u;this._msbAccount=t;BingAtWork.wsb&&(BingAtWork.wsb.wsbAccessToken=r,BingAtWork.wsb.isGCC=n.isGCCTenant(r));f!=r&&(this._tokenChanged=!0,i=this.getTokenExpiry(r,this._msbAccount.ExpireDateTime),this._msbAccount.ExpireDateTime<i&&(n.getIsMsbInternalTenant()&&(u=JSON.stringify({tokenExpiry:i,wamExpiry:this._msbAccount.ExpireDateTime,diff:i-this._msbAccount.ExpireDateTime}),_w.bfbWsbTel&&bfbWsbTel.logError("Wsb WAM token expiry mismatch","",{additionalMessage:u})),this._msbAccount.ExpireDateTime=i))},f.prototype.setSubstrateAccount=function(n){this._substrateAccount=n;BingAtWork.wsb&&(BingAtWork.wsb.wsb3sAccessToken=n.Token)},f.prototype.sendMsbProactiveSignIn=function(t){var i,r=(i={},i["Content-Type"]="text/plain",i),u={Authentication:t};n.fetchUrl(BingAtWork.wsb.isGCC===!0?n.config.msbGccProactiveSigninUrl:n.config.msbProactiveSigninUrl,r,JSON.stringify(u),function(){},undefined,undefined,!0,undefined,!0)},f.prototype.handleMsbTokenChanged=function(){if(this._tokenChanged&&n.isTenantMsbEnabled()){this._tokenChanged=!1;var t=this.getMsbToken();t&&(n.config.msbEnableProactiveSignin&&this.sendMsbProactiveSignIn(t),this._tokenChangedHandlers&&this._tokenChangedHandlers.forEach(function(i){n.safeExecute(function(){return i(t)},"MsbTokenManager::fireTokenChanged")}))}},f.prototype.handleWsbAccessTokenAvailable=function(t){var i=this;t==1&&(this._accountTypeChangedIsFiring||this.callGetMsbAccount(!1,function(t){i.notifyWsbAadReady();!t||(n.MockUrlParameters===null||n.MockUrlParameters===void 0?void 0:n.MockUrlParameters.isTest)||n.Host.refreshCurrentPane(!0);n.config.msbUse3sQuery&&i.refresh3sTokenAndCall(function(){})},"WsbAccessTokenAvailable"))},f.prototype.handleAcountTypeChanged=function(){var t=this,i;this._accountTypeChangedIsFiring=!0;i=function(i){t.callGetMsbAccount(!0,function(){t.notifyWsbAadReady();t._accountTypeChangedIsFiring=!1;n.Host.refreshCurrentPane(!0);n.config.msbUse3sQuery&&t.refresh3sTokenAndCall(function(){})},i)};n.config.msbMockToken?this.getMockToken(function(){i("AccountTypesChanged_withMockToken")}):i("AccountTypesChanged")},f.prototype.handleWsbVerifyAccountRequired=function(n,t){var u,i,f;switch(n){case 1:u="AAD";break;case 0:u="MSA";break;default:u="Unknown"}if(u!="MSA"){switch(t){case"9ea1ad79-fdb6-4f9a-8bc3-2b70f96e34c7":i="BingAtWork";break;case"https://www.bing.com/cortana":i="Cortana";break;case"https://graph.windows.net/":i="GraphWindowsApi";break;case"394866fc-eedb-4f01-8536-3ff84b16be2a":i="PeopleCard";break;case"https://outlook.office.com/":i="ProfilePictureApi";break;case"https://substrate.office.com":i="SubstrateEnterprise";break;case"service::cortana.bing.com::mbi_ssl":i="Cortana";break;case"LiveProfileCard.Access":i="PeopleCard";break;case"https://outlook.office.com/User.ReadWrite":case"https://outlook.office.com/M365.Access":i="ProfilePictureApi";break;case"https://substrate.office.com/SubstrateSearch-Internal.ReadWrite":case"https://substrate.office.com/M365.Access":i="SubstrateConsumer";break;default:i="Unknown"}f=u+"@"+i;this.trySendValueEvents(r,f,{name:"WsbVerifyAccountRequired",value:"",kv:{authType:u,resourceOrScope:i}})}},f.prototype.getAadUserInfo=function(n){var t=n===null||n===void 0?void 0:n.RoutingHint,i,r;return t&&t.startsWith("OID:")&&t.length==77?(i=t.substring(4,40),r=t.substring(41),{TenantId:r,TenantName:n.TenantName,UserAadId:i}):null},f.prototype.updateTelemetryContext=function(t){this._userId=t===null||t===void 0?void 0:t.UserAadId;this._tenantId=t===null||t===void 0?void 0:t.TenantId;_w.bfbWsbTel&&bfbWsbTel.setUid(this._userId);_w.bfbWsbTel&&bfbWsbTel.setTenantId(this._tenantId);n.checkAndSetIsMsbInternalTenant(this._tenantId);(n.config.msbIsMicrosoftInternal||n.getIsMsbInternalTenant())&&_w.bfbWsbTel&&bfbWsbTel.logValue("BfbMsInternalFlag",n.config.msbIsMicrosoftInternal,{WsbAccountIsMsbInternalTenant:n.getIsMsbInternalTenant(),CodeLocation:"MsbTokenManager.updateTelemetryContext"})},f.prototype.clearUserTenantContext=function(){_w.bfbWsbTel&&bfbWsbTel.setUid(null);_w.bfbWsbTel&&bfbWsbTel.setTenantId(null);n.checkAndSetIsMsbInternalTenant(null)},f.prototype.isThrottledLogInfoExpired=function(t,i){var f=this._localStorage.getItem(i),r=this.parseCachedLogInfo(f),u;return r==null?!0:r.LogKey!=t?!0:(u=n.config.msbLogThrottlingTimeInHours*36e5,n.getCurrentTime()>r.SavedTimestamp+u)?!0:!1},f.prototype.parseCachedLogInfo=function(n){var t=n&&n.split(";");return!t||t.length!=2?null:{LogKey:t[1],SavedTimestamp:+t[0]}},f.prototype.updateLogInStorage=function(t,i){var r=n.getCurrentTime()+";"+i;this._localStorage.setItem(t,r)},f.prototype.handleTanentEnabled=function(n){this.trySendValueEvents(i,n,{name:"LogMsbEnabledUserId",value:""})},f.prototype.trySendValueEvents=function(n,t,i){this.isThrottledLogInfoExpired(t,n)&&(_w.bfbWsbTel&&i&&bfbWsbTel.logValue(i.name,i.value,i.kv),this.updateLogInStorage(n,t))},f.prototype.getMsbMockAccount=function(){var t=n.getCurrentTime();return{Token:this._mockToken,ExpireDateTime:t+36e5,RoutingHint:"OID:65e1aedd-5fe9-4100-8b57-7973687b78c4@72f988bf-86f1-41af-91ab-2d7cd011db47",UserName:"msbtest",TenantName:"Microsoft",LastUpdated:t}},f.prototype.getMockToken=function(t){var i=this,r=n.config.msbMockTokenUrl;n.fetchUrl(r,undefined,undefined,function(n){if(n.status===200){try{i._mockToken=JSON.parse(n.responseText)}catch(r){i._mockToken=null}t()}else i._mockToken=null,t()},undefined,undefined,!0)},f}();n.MsbTokenManager=f}(WSB||(WSB={})),function(n){var t,i=(t={},t.Person="People",t.Group="Group",t.Bookmark="Bookmark",t.Building="Building",t.Qna="EditorialQnA",t.File="File",t),r=function(){function t(n){this._msbTokenManager=n;this._lastMiniSerpSearchId=null;this._lastMiniSerpLoadedHandler=null;this.setupMiniSerpPrefetch()}return t.prototype.fetchServerSuggestion=function(t,i,r,u){var f={query:t,count:i,domains:r,clientContext:{clientType:"Wsb"}},e=JSON.stringify(f),o={url:BingAtWork.wsb.isGCC===!0?n.config.msbGccServerQfUrl:n.config.msbServerQfUrl,requestType:"POST",body:e,onSuccess:function(n){u(n&&n.results)},onError:function(){u([])}};n.Msb.sendAjax(o)},t.prototype.fetchSearchResponse=function(t,i,r,u){n.config.msbUse3sQuery?this.refreshTokenAndFetchMsb3sQueryResponse(t,i,r,u):this.fetchMsbSearchResponse(t,i,r,u)},t.prototype.refreshTokenAndFetchMsb3sQueryResponse=function(n,t,i,r){var u=this;this._msbTokenManager.refresh3sTokenAndCall(function(){u.fetchMsb3sQueryResponse(n,t,i,r)},r)},t.prototype.fetchMsb3sQueryResponse=function(t,i,r,u){var f=this,s=n.config.msb3sQueryUrl,e=this.buildMsb3sQueryRequest(t,i),h=JSON.stringify(e),o;this.fireResetSearchOptions();o={url:s,useToken:"WSB3S",requestType:"POST",body:h,onSuccess:function(o,s){var h,c;o?f.is3sResponseEmpty(o,i)?(h="[MSB.Error] fetchMsb3sQueryResponse received empty searchResponse or searchResponse.results for query "+t,c=n.getIsMsbInternalTenant()?h:"",_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Search Response Empty Results","",{serverTraceId:s,additionalMessage:c}),u()):r(o,e):(h="[MSB.Error] fetchMsb3sQueryResponse received empty response for query "+t+" of intent "+i,_w.bfbWsbTel&&bfbWsbTel.logError("Wsb 3S Query Response is Empty","",{serverTraceId:s}),u())},onError:function(r,f){var s=f.responseText,h=f.message,c=f.stackTrace,l=f.serverTraceId,a="[MSB.Error] fetchMsb3sQueryResponse failed, details="+JSON.stringify({queryText:t,intent:i,statusCode:r,responseText:s,message:h,stackTrace:c,serverTraceId:l}),e,o;e=n.getIsMsbInternalTenant()?"Query: "+t+", intent: "+i+", responseText: "+(f===null||f===void 0?void 0:f.responseText)+", errorMEssage: "+f.errorMessage:"";o=n.getIsMsbInternalTenant()?f===null||f===void 0?void 0:f.stackTrace:"";_w.bfbWsbTel&&bfbWsbTel.logHttpError("Wsb Fetch Search Response Failed",f===null||f===void 0?void 0:f.message,{stackTrace:o,serverTraceId:f===null||f===void 0?void 0:f.serverTraceId,statusCode:r,additionalMessage:e});u()},onRoundTripReport:function(n){f.fireRoundTripTime("SubstrateSearch_RoundTripTime",n)}};n.Msb.sendAjax(o)},t.prototype.fetchMsbSearchResponse=function(t,i,r,u){var o=this,e;var s=n.getMsbUrl("v3/search"),f=this.buildMsbSearchRequest(t,i),h=JSON.stringify(f),c=n.Host.createGuid();this.fireResetSearchOptions();e={url:s,requestType:"POST",body:h,onSuccess:function(e,o){var h,s,l;e?(h=e,h.results&&h.results.length!=0?(h.wsbRequestId=c,r(h,f)):(s="[MSB.Error] fetchMsbSearchResponse received empty searchResponse or searchResponse.results for query "+t,l=n.getIsMsbInternalTenant()?s:"",_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Search Response Empty Results","",{serverTraceId:o,additionalMessage:l}),u())):(s="[MSB.Error] fetchMsbSearchResponse received empty response for query "+t+" of intent "+i,l=n.getIsMsbInternalTenant()?s:"",_w.bfbWsbTel&&bfbWsbTel.logError("Wsb Search Response is Empty","",{serverTraceId:o,additionalMessage:l}),u())},onError:function(r,f){var s=f.responseText,h=f.message,c=f.stackTrace,l=f.serverTraceId,a="[MSB.Error] fetchMsbSearchResponse failed, details="+JSON.stringify({queryText:t,intent:i,statusCode:r,responseText:s,message:h,stackTrace:c,serverTraceId:l}),e,o;e=n.getIsMsbInternalTenant()?"Query: "+t+", intent: "+i+", responseText: "+(f===null||f===void 0?void 0:f.responseText)+", errorMEssage: "+f.errorMessage:"";o=n.getIsMsbInternalTenant()?f===null||f===void 0?void 0:f.stackTrace:"";_w.bfbWsbTel&&bfbWsbTel.logHttpError("Wsb Fetch Search Response Failed",f===null||f===void 0?void 0:f.message,{stackTrace:o,serverTraceId:f===null||f===void 0?void 0:f.serverTraceId,statusCode:r,additionalMessage:e});u()},onRoundTripReport:function(n){o.fireRoundTripTime("Search_RoundTripTime",n)}};n.Msb.sendAjax(e)},t.prototype.getPersonPhotoData=function(t,i,r){var u=n.getMsbUrl(i?"v3/search/person/photo":"v3/search/group/photo"),f={clientContext:{clientType:"Wsb"},id:t},e=JSON.stringify(f),o={url:u,requestType:"POST",body:e,onSuccess:function(n){n&&n.imageInBase64?r("data:image/jpeg;base64,"+n.imageInBase64):r(null)},onError:function(){r(null)}};n.Msb.sendAjax(o)},t.prototype.fireResetSearchOptions=function(){var t,i={messageType:"MSB_RESET_SEARCH_OPTIONS",payload:{wsbIG:(t=window===null||window===void 0?void 0:window._G)===null||t===void 0?void 0:t.IG}};n.safeExecute(function(){window.postMessage(i,window.location.origin)},"fireResetSearchOptions")},t.prototype.fireSearchResponse=function(t,i){n.config.msbUse3sQuery?this.fireMsb3sQueryResponse(t,i):this.fireMsbSearchResponse(t,i)},t.prototype.fireMsb3sQueryResponse=function(t,i){var r=this.buildMsb3sQueryRequest(t),u=n.Host.createGuid(),f={messageType:"MSB_SET_3S_QUERY_RESPONSE",payload:{requestId:u,request:r,response:i}};n.safeExecute(function(){window.postMessage(f,window.location.origin)},"fireSearchResponse")},t.prototype.fireMsbSearchResponse=function(t,i){var r=this.buildMsbSearchRequest(t),u={messageType:"MSB_SET_SEARCH_RESPONSE",payload:{requestId:i.wsbRequestId,request:r,response:i}};n.safeExecute(function(){window.postMessage(u,window.location.origin)},"fireSearchResponse")},t.prototype.fireClientQfResponse=function(t,i){this.fireResetSearchOptions();var r=i,u=this.buildMsb3sQueryRequest(t),f={messageType:"MSB_SET_CLIENT_QF_RESPONSE",payload:{request:u,response:r}};n.safeExecute(function(){window.postMessage(f,window.location.origin)},"fireClientQfResponse")},t.prototype.fireRoundTripTime=function(t,i){var r=Object.assign({eventId:t},i),u;u={messageType:"MSB_SEARCH_RTT",payload:r};n.safeExecute(function(){window.postMessage(u,window.location.origin)},"fireRoundTripTime")},t.prototype.buildMsb3sQueryRequest=function(n,t){var r=i[t],u=r!=null?[r]:[];switch(t){case"File":return{Cvid:BingAtWork.context.conversationId,EntityRequests:[{Query:{QueryString:n,DisplayQueryString:n},ContentSources:["SharePoint","OneDriveBusiness"],EntityType:r,From:0,Size:1}],Scenario:{Name:"Wsb.PreviewPane"},TextDecorations:"Off"};default:return{Cvid:BingAtWork.context.conversationId,AnswerEntityRequests:[{Query:{QueryString:n},EntityTypes:u,From:0,Size:1}],Scenario:{Name:"Wsb.PreviewPane"},TextDecorations:"Off"}}},t.prototype.buildMsbSearchRequest=function(t,i){return{query:t,requestContext:{clientSize:"Small",queryIntent:i},clientContext:{clientType:"Wsb",timeZoneOffsetInMinutes:-1*n.getCurrentDate().getTimezoneOffset()}}},t.prototype.is3sResponseEmpty=function(n,t){var i,r;return t==="File"?(i=n,!i.EntitySets||i.EntitySets.length===0):(r=n,!r.AnswerEntitySets||r.AnswerEntitySets.length===0)},t.prototype.setupMiniSerpPrefetch=function(){n.config.msbEnableMiniSerp&&n.config.msbEnableMiniSerpPrefetch&&!n.config.msbUse3sQuery&&(this.handleMiniSerpFetch=this.handleMiniSerpFetch.bind(this),sj_evt.unbind(n.MiniSerpFetchEvent,this.handleMiniSerpFetch),sj_evt.bind(n.MiniSerpFetchEvent,this.handleMiniSerpFetch))},t.prototype.handleMiniSerpFetch=function(i){var r=this,u=i&&i.length>1&&i[1],f=u&&u.query;f&&(this._lastMiniSerpSearchId&&this._lastMiniSerpLoadedHandler&&(sj_evt.unbind(n.MiniSerpLoadedEvent,this._lastMiniSerpLoadedHandler),this._lastMiniSerpSearchId=null,this._lastMiniSerpLoadedHandler=null),this._lastMiniSerpSearchId=n.Host.createGuid(),this.fetchSearchResponse(f,undefined,function(i,u){r._lastMiniSerpLoadedHandler=function(){var r=function(f){var o=_ge(n.MiniSerpIframeId),e=o&&o.contentWindow;if(!e.sj_evt||!e.BingAtWork){f>0&&sb_st(function(){return r(f-1)},50);return}e.BingAtWork.wsb=BingAtWork.wsb;e.BingAtWork.searchPrefetchRequest=u;e.sj_evt.fire(t.MsbSearchReadyEvent,i,u)};r(200)};sj_evt.bind(n.MiniSerpLoadedEvent,r._lastMiniSerpLoadedHandler)},function(){}))},t.MsbSearchReadyEvent="bfbCommand",t}();n.MsbDataAccess=r}(WSB||(WSB={})),function(n){function t(){var t;return{domainOptions:(t={},t.Person={spaceInTheMiddleRequired:!1,minimumMatchCount:n.config.msbMinMatchPerson||i},t.Bookmark={minimumMatchCount:n.config.msbMinMatchBookmark||i},t.Building={minimumMatchCount:n.config.msbMinMatchBuilding||i},t.Group={minimumMatchCount:n.config.msbMinMatchGroup||i},t.Qna={minimumMatchCount:n.config.msbMinMatchQna||i},t.File={minimumMatchCount:n.config.msbMinMatchFile||i},t),ignoreChars:"parenDash"}}function u(){var i=t().domainOptions,n=Number.MAX_VALUE;for(var r in i)n=i[r].minimumMatchCount<n?i[r].minimumMatchCount:n;return{minimumQueryLength:n}}function p(t){return t.isSearchHomeZI?y:n.isL2(t)?t.scope===n.Scope.People?l:t.scope===n.Scope.Web?a:t.scope===n.Scope.Documents?v:undefined:n.isMsbFileEnabled()?c:h}function f(t){var i=["Person","Bookmark","Group","Qna"];return n.config.msbDisableBuilding||i.push("Building"),t&&i.push("File"),i}function w(){switch(n.config.msbQwsDomains){case 0:return["Person","Bookmark"];case 2:return["Bookmark"];case 1:return["Person"];default:return["Person","Bookmark"]}}function b(){var t=["Bookmark","Qna"];return n.config.msbDisableBuilding||t.push("Building"),t}function k(){return["File"]}var e="CS",o="NT",s="NE",i=6,r="msb:qf:atrdy",h={suggestionConfidenceOptions:t(),serverSuggestionOptions:u(),domains:f(),count:n.config.msbQfResultsCountL1},c={suggestionConfidenceOptions:t(),serverSuggestionOptions:u(),domains:f(!0),count:n.config.msbQfResultsCountL1},l={suggestionConfidenceOptions:t(),domains:["Person","Group"],count:n.config.msbQfResultsCountL2},a={suggestionConfidenceOptions:t(),domains:b(),count:n.config.msbQfResultsCountL2},v={suggestionConfidenceOptions:t(),domains:k(),count:n.config.msbQfResultsCountL2},y={suggestionConfidenceOptions:t(),domains:w(),count:n.config.msbQfResultsCountQws,dynamicRanking:n.config.msbEnableQwsDynamicRanking},d=6048e5,g=function(){function t(t,i,u){var f=this,e;this._dataSource=t;this._msbTokenManager=i;this._lightweightStorage=u;this._tokenChangedFired=!1;this._clientQfReadyFired=!1;this._clientQfTokenReady=!1;this._logId=this.getName()+"["+this._dataSource+"]";this._msbDataModule=_w.BingAtWork;this._msbTokenManager.bindTokenChanged(function(){f._tokenChangedFired=!0;f.updateClientQfAccessToken()});e=function(){f._clientQfReadyFired=!0;f.updateClientQfAccessToken();sj_evt.unbind(r,e)};sj_evt.bind(r,e,!0,null,!0);this._fetchClientQfResponse=n.config.msbServerBackfill?this.fetchSuggestionsWithServerBackfill:this.fetchLocalSuggestions;n.MockUrlParameters?n.setIsMsbClientQfTokenReady(this._lightweightStorage,!0):n.setIsMsbClientQfTokenReady(this._lightweightStorage,!1);n.config.msbQwsCleanCache&&n.setQuickWorkSearchCache(this._lightweightStorage,null)}return t.prototype.getName=function(){return"MsbClientQfDataProvider"},t.prototype.fetch=function(t,i,r,u,f){var l,o,c,h,v,w,y;if(n.config.msbEnableDeltaSync&&n.isMsbFileEnabled()&&t.isSearchHomeZI&&this.isClientQfReady()&&this._clientQfTokenReady&&this.initDeltaSyncCall(),l=n.isDataSourceEnabled(this._dataSource,t),t.isSearchHomeZI&&n.isAuthLogEnabled()&&_w.bfbWsbTel&&bfbWsbTel.logPerf("[MsbClientQfDataProvider]: fetch SearchHome",{msbTenantStatus:n.getTenantMsbStatus(),shouldForceEnterpriseAccount:n.shouldForceEnterpriseAccount(),MsbQfReady:n.getIsMsbClientQfTokenReady(this._lightweightStorage),clientQfState:n.getMsbClientQfState(),isClientQfReady:this.isClientQfReady(),isClientQfTokenReady:this._clientQfTokenReady,dataSourceEnabled:l,isMsftAccountConnected:n.isMsftAccountConnected}),l){if(o=!1,t.isSearchHomeZI&&n.enableQwsCache()&&(c=n.getQuickWorkSearchCache(this._lightweightStorage),c)){h=void 0;try{h=JSON.parse(c)}catch(a){v="[MSB.Error]  "+this._logId+".fetch: QWS cache is broken.\n                            cacheString="+c+",\n                            error.message="+(a===null||a===void 0?void 0:a.message);w=n.getIsMsbInternalTenant()?v:"";_w.bfbWsbTel&&bfbWsbTel.logError("Wsb quick work search cache broken","",{additionalMessage:w});n.setQuickWorkSearchCache(this._lightweightStorage,null)}h&&(n.getCurrentTime()-h.lastUpdatedTime<d?(i(this._dataSource,h.results,null),o=!0):n.setQuickWorkSearchCache(this._lightweightStorage,null))}if(!n.isTenantMsbEnabled()){o||i(this._dataSource,null,s);return}if(!(this.isClientQfReady()&&this._clientQfTokenReady||n.MockUrlParameters)){o||i(this._dataSource,null,e);return}if(y=p(t),!y){o||i(this._dataSource,null,null);return}this.getAcessTokenAndFederate(t,i,f,u,y)}},t.prototype.getAcessTokenAndFederate=function(n,t,i,r,u){var f=this;this._msbTokenManager.refreshMsbTokenAndCall(function(){f._fetchClientQfResponse(n,t,i,u)},function(){t(f._dataSource,null,o)})},t.prototype.fetchSuggestionsWithServerBackfill=function(t,i,r,u){var f=this,e={isFirstStageProcessed:!1,enoughSuggestionsReceived:!1};t.isSearchHomeZI?n.MockUrlParameters&&typeof n.MockQwsResponse=="object"?this.processClientQwsResponse(n.MockQwsResponse,i,r):this._msbDataModule.getZeroQfSuggestions(function(t){if(n.enableQwsCache()){if(n.getQuickWorkSearchCache(f._lightweightStorage)||f.processClientQwsResponse(t,i,r),t.length>0){var u={results:t,lastUpdatedTime:n.getCurrentTime()};n.setQuickWorkSearchCache(f._lightweightStorage,JSON.stringify(u))}}else f.processClientQwsResponse(t,i,r)},function(t){var u="[MSB.Error]  "+f._logId+".fetchSuggestionsWithServerBackfill: \n                                getZeroQfSuggestions returned with error, details="+JSON.stringify(t),e;e=n.getIsMsbInternalTenant()?u:"";_w.bfbWsbTel&&bfbWsbTel.logError("Wsb quick work search fetch threw error","",{additionalMessage:e});f.processClientQwsResponse([],i,r)},u):(this._msbDataModule.getExtraSuggestions(t.queryToFetch,function(n){f.processClientQfResponseTwoStage(n,i,e,r,u)},function(n){f.processClientQfResponseTwoStage([],i,e,r,u)}),this._msbDataModule.getSuggestions(t.queryToFetch,function(n){f.processClientQfResponseTwoStage(n,i,e,r,u)},function(n){f.processClientQfResponseTwoStage([],i,e,r,u)},u))},t.prototype.fetchLocalSuggestions=function(n,t,i,r){var u=this;this._msbDataModule.getExtraSuggestions(n.queryToFetch,function(n){},function(n){});this._msbDataModule.getSuggestions(n.queryToFetch,function(n){u.processClientQfResponse(n,t,i)},function(n){},r)},t.prototype.processClientQfResponse=function(n,t,i){if(i()){if(!n){t(this._dataSource,null,null);return}var r=n;t(this._dataSource,r,null)}},t.prototype.processClientQfResponseTwoStage=function(n,t,i,r,u){if(r()&&!i.enoughSuggestionsReceived){n||(n=[]);i.enoughSuggestionsReceived=u.count&&n.length>=u.count;var f=!(i.enoughSuggestionsReceived||i.isFirstStageProcessed);t(this._dataSource,n,null,0,!1,f);i.isFirstStageProcessed=!0}},t.prototype.processClientQwsResponse=function(t,i,r){r()&&(t||(t=[]),t.length==0&&n.isAuthLogEnabled()&&_w.bfbWsbTel&&bfbWsbTel.logError("Wsb quick work search return empty suggestions"),i(this._dataSource,t,null,0,!1,!1))},t.prototype.isClientQfReady=function(){var n=BingAtWork.msbDataContext;return n&&n.initializeFired&&n.readyFired},t.prototype.updateClientQfAccessToken=function(){var t=this,i;this._tokenChangedFired&&this._clientQfReadyFired&&n.isTenantMsbEnabled()&&(i=this._msbTokenManager.getMsbToken(),i&&this._msbDataModule.setAccessToken(i,function(){t._clientQfTokenReady=!0;n.setIsMsbClientQfTokenReady(t._lightweightStorage,!0)},function(n){}))},t.prototype.initDeltaSyncCall=function(){this._msbDataModule.initDeltaSyncCall(!1,function(){},function(n){})},t}();n.MsbClientQfDataProvider=g}(WSB||(WSB={}));__spreadArrays=this&&this.__spreadArrays||function(){for(var i=0,n=0,r=arguments.length;n<r;n++)i+=arguments[n].length;for(var u=Array(i),f=0,n=0;n<r;n++)for(var e=arguments[n],t=0,o=e.length;t<o;t++,f++)u[f]=e[t];return u},function(n){function r(n){return v+"_"+n}function p(n,t){t(y)}function s(n){var t,i;return n&&(t=n.lastIndexOf("."),t>=0)?(i=n.indexOf("&",t),i>=0?n.substring(t,i):n.substring(t)):""}function w(t,i){var r=s(t);return n.getIconForTypeAsync(i,r)}var t,i=n.mapOSFormCode("BFBWSL"),u=1,h=.6,f=2,c=4,e=/[0-9a-zA-Z]/,l=/\s+/g,o=(t={},t.Person="MPPL",t.Group="MGRP",t.Bookmark="MBKS",t.Building="MBLD",t.Qna="MQNA",t.File="MFIL",t),a=6048e5,v="MsbPersonIcon",y={type:0,className:"msb-suggIcon",content:"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDQ4IDIwNDgiIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+DQogIDxwYXRoIGQ9Ik0xNzYyIDE1OTBxNjYgMzIgMTE4IDgwdDkwIDEwOCA1OCAxMjggMjAgMTQyaC0xMjhxMC03OS0zMC0xNDl0LTgzLTEyMi0xMjItODItMTQ5LTMxcS03OSAwLTE0OSAzMHQtMTIyIDgzLTgyIDEyMi0zMSAxNDloLTEyOHEwLTczIDIwLTE0MXQ1Ny0xMjggOTAtMTA4IDExOS04MXEtNzUtNTQtMTE2LTEzNXQtNDItMTc1cTAtNzkgMzAtMTQ5dDgyLTEyMiAxMjItODMgMTUwLTMwcTc5IDAgMTQ5IDMwdDEyMiA4MiA4MyAxMjMgMzAgMTQ5cTAgOTMtNDEgMTc0dC0xMTcgMTM2em0tMjI2LTU0cTUzIDAgOTktMjB0ODItNTUgNTUtODEgMjAtMTAwcTAtNTMtMjAtOTl0LTU1LTgyLTgxLTU1LTEwMC0yMHEtNTMgMC05OSAyMHQtODIgNTUtNTUgODEtMjAgMTAwcTAgNTMgMjAgOTl0NTUgODIgODEgNTUgMTAwIDIwem01MTItMTQwOHYxMDI0cTAtNDgtOS04NHQtMjUtNjctNDAtNjAtNTQtNjNWMjU2SDEyOHYxMTUyaDI1NnYyNjdsMjY3LTI2N2gzOTBxOCAzNCAyMSA2NnQzMSA2Mkg3MDRsLTQ0OCA0NDh2LTQ0OEgwVjEyOGgyMDQ4eiIgLz4NCjwvc3ZnPg=="},b=function(){function t(n,t){this._msbDataAccess=n;this._lightweightStorage=t;this.bookmarkIcon={content:"&#xEB8F",type:2};this.locationIcon={content:"&#xECAF",type:2}}return t.prototype.parse=function(t,i,r,u,f,e){var o,s;if(n.isDataSourceEnabled(r,t)){if(!u||u.length<1){e(r,[],null);return}o=this.pickUpClientQfResults(t,u);this.createClientQfSuggestionsFor(t,i,o);s=o.map(function(n){return n.wsbSuggestion});e(r,s,null)}},t.prototype.setRankingValues=function(n,t,i){n.suggestionLogMeta='40000:"'+t+'";40001:"'+i+'"'},t.prototype.createMsbSuggestion=function(t,i,r,u,f,e,s,h,c,l,a,v){var d=this,p=o[s],g=t.isSearchHomeZI?i:HitHighlightingParser.addMarkers(i,t.originalQuery),y=n.createSuggestion(t,g,u,f,p,i,n.InstrumentedItem.createInstrumentedItem(e,p),17,e,!0),w,b,k;r&&(y.autoOpenPreviewPaneWhenOnTopHit=!0,y.allowedInGroups=!0);c&&(y.primaryMetadata=c);y.previewCallback=a;y.click=this.isQwsRequerysEnabled(t)?function(){d.reformulateOnQwsSuggestionClick(t,i,s)}:v;y.msbDomain=s;y.msbId=h;y.reactKey=p+s+h;l&&(y.classNames=(y.classNames||[]).concat(l));switch(p){case"MPPL":n.isL2(t)&&(y.sourceForGroup=6);t.isSearchHomeZI&&n.qwsShowTopList()&&this.adjustPersonName(y);break;case"MGRP":n.isL2(t)&&(y.sourceForGroup=5);break;case"MFIL":w=n.getScopeDisplayName(n.ScopeConfig[n.Scope.Documents]);b=n.SubstrateTenantName||"";y.groupDisplayName=w+" - "+b;break;default:t.isSearchHomeZI||(k=n.SubstrateTenantName||"",y.groupDisplayName=n.Host.getLocString("TenantBookmarksGroup",k))}return y},t.prototype.createGetPersonIcon=function(t,i,u){var f=this;return function(e,o){var v=!1,h,s,l,y;if(h=f._lightweightStorage.getItem(r(t)),h){s=void 0;try{s=JSON.parse(h)}catch(c){l="[MSB.Error] MsbQfSuggestionsParser.createGetPersonIcon: Person icon cache is broken.\n                            uid="+t+",\n                            cacheString="+h+",\n                            error.message="+(c===null||c===void 0?void 0:c.message);y=n.getIsMsbInternalTenant()?l:"";_w.bfbWsbTel&&bfbWsbTel.logError("Wsb person icon cache broken","",{additionalMessage:y});f._lightweightStorage.removeItem(r(t))}s&&(n.getCurrentTime()-s.lastUpdatedTime<a?(o(s.data),v=!0):f._lightweightStorage.removeItem(r(t)))}f._msbDataAccess.getPersonPhotoData(t,i,function(i){var e=u,s;i&&(e=n.toIcon(i,"createGetPersonIcon"),s={data:e,lastUpdatedTime:n.getCurrentTime()},f._lightweightStorage.setItem(r(t),JSON.stringify(s)));v||o(e)})}},t.prototype.getDefaultIcon=function(n){var t,i=n.trim().replace(l," ").split(" ",2),r,u;return i.length>0&&(r=i[0][0],e.test(r)&&(t=r),i.length==2&&(u=i[1][0],t&&e.test(u)?t+=u:t="")),{type:t?5:2,content:t?t.toUpperCase():"&#xE77B",className:"peopleIcon"}},t.prototype.buildPreviewResponse=function(n,t,i,r){var o,f;n.normalizedQuery=r;n.ranking.entityCards=[{cardType:"Hero",domain:t,entityIds:[i]}];n.ranking.placement="Carousel";var e=n.results.filter(function(n){return n.domain===t}),s=n.results.filter(function(n){return n.domain!==t}),u=e&&e[0],h=u&&u.results&&u.results.filter(function(n){return n.id===i}),c=u&&u.results&&u.results.filter(function(n){return n.id!==i});return u&&(f=[],h&&f.push.apply(f,h),c&&f.push.apply(f,c),u.results=f),n.results=e||[],s&&(n.results=(o=n.results).concat.apply(o,s)),n},t.prototype.pickUpClientQfResults=function(t,i){for(var r,s,e,o=!1,w=0,v=0,b=n.isL2(t),y=[],l=[],a=0,p=i;a<p.length;a++)(r=p[a],t.isSearchHomeZI&&r.domain==="Person"&&v>=c)||(r.domain!=="Group"||r.identifiers!=null&&r.identifiers.uniqueName!=null)&&(r.confidence==="High"?(o=!0,e={msbSuggestion:r,isHero:!b&&w++<f,score:u},y.push(e)):(o||r.confidence==null||(o=!0),e={msbSuggestion:r,isHero:!1,score:h},l.push(e)),r.domain==="Person"&&v++);if(!o)for(s=0;s<f;s++)e=l[s],e&&(e.isHero=!0,e.score=u);return __spreadArrays(y,l)},t.prototype.createClientQfSuggestionsFor=function(n,t,i){for(var u,f,r=0;r<i.length;r++)u=i[r],f=this.buildClientQfSuggestion(n,t,u),this.setRankingValues(f,r,u.score),u.wsbSuggestion=f},t.prototype.buildClientQfSuggestion=function(t,r,u){var h=this,f=u.msbSuggestion,g=u.isHero,l=f.query,v=f.query,a=undefined,o=undefined,y=undefined,s=undefined,k,e,b,d,c;switch(f.domain){case"Bookmark":o=this.bookmarkIcon;k=f.identifiers;s=function(){n.Host.launchUri(k.url)};break;case"Person":e=this.getDefaultIcon(l);a=this.createGetPersonIcon(f.id,!0,e);o=e;y="msb-people";s=function(){var t=f.identifiers,r=n.buildBfbSearchUrl(n.config,v,"Person",t.uniqueName,i);n.Host.launchUri(r)};break;case"Group":e=this.getDefaultIcon(l);a=this.createGetPersonIcon(f.id,!1,e);o=e;y="msb-people";s=function(){var t=f.identifiers,r=n.buildBfbSearchUrl(n.config,v,"Group",t.uniqueName,i);n.Host.launchUri(r)};break;case"Building":o=this.locationIcon;s=function(){var t=n.buildBfbSearchUrl(n.config,v,"Building",undefined,i);n.Host.launchUri(t)};break;case"Qna":e=this.getDefaultIcon(l);a=p;o=e;s=function(){var t=n.buildBfbSearchUrl(n.config,v,"Qna",undefined,i);n.Host.launchUri(t)};break;case"File":e=n.ScopeConfig[n.Scope.Documents].icon;b=f.identifiers;a=w(b.url,e);o=e;s=function(){n.Host.launchUri(b.url)}}return d=function(t,i,r){var u=h.getQueryText(f),e;if(f.domain==="File"){if(!(r===null||r===void 0?void 0:r(f.id,f.domain)))return;e=f;e.locationPath=c.parentFolder;h._msbDataAccess.fireClientQfResponse(u,e);t===null||t===void 0?void 0:t();return}h._msbDataAccess.fetchSearchResponse(u,f.domain,function(i){if(r===null||r===void 0?void 0:r(f.id,f.domain)){if(n.config.msbUse3sQuery)h._msbDataAccess.fireSearchResponse(u,i);else{var e=i,o=h.buildPreviewResponse(e,f.domain,f.id,l);h._msbDataAccess.fireSearchResponse(u,o)}t===null||t===void 0?void 0:t()}},function(){i===null||i===void 0?void 0:i(f.query)})},c=this.createMsbSuggestion(t,l,g,a,o,r,f.domain,f.id,f.title,y,d,s),f.domain==="File"&&this.updateFileSuggestion(t,f,c),n.isL2(t)&&t.scope===n.Scope.People&&(c.template=1,c.classNames.push("people","topResultTemplateInGroups")),c},t.prototype.getProvenance=function(n){switch(n.source.toLocaleLowerCase()){case"onedriveforbusiness":return"OneDriveBusiness";case"sharepoint":default:return"SharePoint"}},t.prototype.updateFileSuggestion=function(t,i,r){var u,e;r.author=i.author;r.lastModifiedBy=i.lastModifiedBy;r.lastModifiedDate=n.toDate(i.timestamp);r.url=i.identifiers&&i.identifiers.url;r.siteTitle=i.title;i.fileExtension&&(u="."+i.fileExtension,r.extensionLC=u.toLocaleLowerCase(),r.query.endsWith(u)||(r.query=r.query+u),r.text!==r.query&&(r.text=r.query));e=this.getProvenance(i);n.setDocumentLocationProperties(r,i.query,e,!1);var o=r.author,s=r.lastModifiedBy,f=n.getEffectiveQuery(t);n.matchesOnPropertyHH(o,f)?r.match=n.createMatch(n.MatchType.Author,o):n.matchesOnPropertyHH(s,f)&&(r.match=n.createMatch(n.MatchType.LastModifiedBy,s));n.setFileTemplate(t,f,n.isL2(t),r)},t.prototype.reformulateOnQwsSuggestionClick=function(t,i,r){var u,f,e=n.config.msbEnableQwsRequeryPeoplePrefix&&r==="Person"?(f=(u=n.ScopeConfig[n.Scope.People])===null||u===void 0?void 0:u.prefixes)===null||f===void 0?void 0:f[0]:"",h=e?e+": "+i:i,s=o[r];n.Host.reformulateNonForcedMiniSerp(h,t.isSearchHomeZI,s);n.Host.setFocusInSearchBox(null,s+".click")},t.prototype.isQwsRequerysEnabled=function(t){return t.isSearchHomeZI&&n.enableQws()&&n.config.msbEnableQwsRequery},t.prototype.getQueryText=function(n){var t=n.query,i;switch(n.domain){case"Person":case"Group":t=n.identifiers&&n.identifiers.uniqueName||t;break;case"File":i=n.identifiers;t=t+s(i.url)}return t},t.prototype.adjustPersonName=function(t){var i=n.getFirstAndLastName(t.text),r,u;i&&(r=i.firstName,u=i.lastName,t.text=r,t.additionalInfoText=u)},t}();n.MsbQfSuggestionsParser=b}(WSB||(WSB={})),function(n){var t;(function(t){function i(t,i){var u,f,e,h,c;if(t!=null&&t.url){if(u=function(n,i){if(t.onError!=null)t.onError(n,i)},t.useToken==="WSB3S"){if(f=_w.BingAtWork&&_w.BingAtWork.wsb&&_w.BingAtWork.wsb.wsb3sAccessToken,!f){u(n.ClientErrorCode.NoWsbAccessToken,{message:"MsbDataAccess.sendAjax: no WSB/3S access token, won't send the request."});return}}else if(f=_w.BingAtWork&&_w.BingAtWork.wsb&&_w.BingAtWork.wsb.wsbAccessToken,!f){u(n.ClientErrorCode.NoWsbAccessToken,{message:"MsbDataAccess.sendAjax: no WSB access token, won't send the request."});return}t.url[0]==="/"&&(t.url=(_w==null?"":_w.location.origin)+t.url);e=0;switch(t.requestType){case"POST":e=1;break;case"PUT":e=4}var o=SearchAppWrapper.CortanaApp,l=o.createStringMap(),s=o.createStringMap();s.Authorization="Bearer "+f;s.Accept="*/*";l["Content-Type"]="application/json";h=performance.now();c=new Date;n.Async.safeChain("makeHttpRequestAsync_MsbDataAccess_Ajax",function(){return o.makeHttpRequestAsync(e,t.url,s,t.body||"",l)},function(f){var e=n.getTraceIdFromHeader(f);if(t.onRoundTripReport){var o=r(f),s=f.statusCode==200?undefined:"HTTP"+f.statusCode,l=performance.now(),a=new Date,v=f.statusCode;t.onRoundTripReport({startTime:h,endTime:l,startDateTime:c,endDateTime:a,serverLatency:o,errorMessage:s,status:v,traceId:e})}f.statusCode===200?n.Async.safeChain("readResponse",function(){return f.readAsStringAsync()},function(r){if(t.onSuccess!=null){var f=null;if(r!=="")try{f=i?r:JSON.parse(r)}catch(o){u(n.ClientErrorCode.ResponseJsonParseError,{message:"Bad data",responseText:r,serverTraceId:e});return}t.onSuccess(f,e)}},function(t){u(n.ClientErrorCode.ReadResponseError,{message:"readAsStringAsync_makeHttpRequestAsync_MsbAjax Error",errorMessage:"Name: "+t.name+", message: "+t.message,stackTrace:""+t.stack,serverTraceId:e})},null,null,0):n.Async.safeChain("readNon200Response",function(){return f.readAsStringAsync()},function(n){u(f.statusCode,{message:"Ajax call failed with status "+f.statusCode.toString()+". No retries attempted.",responseText:n,serverTraceId:e})},function(t){u(n.ClientErrorCode.ReadResponseError,{message:"readAsStringAsync_Non200_makeHttpRequestAsync_MsbAjax Error",errorMessage:"Name: "+t.name+", Message: "+t.message,stackTrace:""+t.stack,serverTraceId:e})},null,null,0)},function(i){if(t.onRoundTripReport){var r=performance.now(),f=new Date,o=n.ClientErrorCode.MsbAjaxMakeHttpRequestAsyncError;t.onRoundTripReport({startTime:h,endTime:r,startDateTime:c,endDateTime:f,errorMessage:"Promise error makeHttpRequestAsync_MsbAjax Error",status:o})}u(n.ClientErrorCode.MsbAjaxMakeHttpRequestAsyncError,{message:"Promise error makeHttpRequestAsync_MsbAjax Error",errorMessage:"Name: "+i.name+", Message: "+i.message+", RequestType: "+e+", RequestUrl: "+t.url+" ",stackTrace:""+i.stack})},null,null,0)}}function r(n){var t;if((t=n===null||n===void 0?void 0:n.headers)!==null&&t!==void 0)return t["x-end2endlatencyms"]}t.sendAjax=i})(t=n.Msb||(n.Msb={}))}(WSB||(WSB={}));1